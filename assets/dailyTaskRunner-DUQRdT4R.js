import"./index-COVLnS54.js";const T=t=>{var m,c,i,o,r;if(!t)return null;if(Array.isArray(t)){const u=t[0];return(u==null?void 0:u.roleId)||(u==null?void 0:u.id)||(u==null?void 0:u.targetId)}const a=((m=t==null?void 0:t.rankList)==null?void 0:m[0])||((c=t==null?void 0:t.roleList)==null?void 0:c[0])||((i=t==null?void 0:t.targets)==null?void 0:i[0])||((o=t==null?void 0:t.targetList)==null?void 0:o[0])||((r=t==null?void 0:t.list)==null?void 0:r[0]);if(a){if(a.roleId)return a.roleId;if(a.id)return a.id;if(a.targetId)return a.targetId}return(t==null?void 0:t.roleId)||(t==null?void 0:t.id)||(t==null?void 0:t.targetId)},f=t=>{if(!t)return!0;const a=new Date().toDateString(),m=new Date(t*1e3).toDateString();return a!==m},B=()=>{const t=[9904,9905,9901,9902,9903,9904,9905],a=new Date().getDay();return t[a]};class O{constructor(a){this.tokenStore=a}log(a,m="info"){var c;(c=this.callbacks)!=null&&c.onLog&&this.callbacks.onLog({time:new Date().toLocaleTimeString(),message:a,type:m})}async executeGameCommand(a,m,c={},i="",o=8e3){try{i&&this.log(`执行: ${i}`);const r=await this.tokenStore.sendMessageWithPromise(a,m,c,o);return await new Promise(u=>setTimeout(u,500)),i&&this.log(`${i} - 成功`,"success"),r}catch(r){throw i&&this.log(`${i} - 失败: ${r.message}`,"error"),r}}async switchToFormationIfNeeded(a,m,c){var i;try{this.log(`检查${c}配置...`);const o=await this.executeGameCommand(a,"presetteam_getinfo",{},"获取阵容信息");(!o||!o.presetTeamInfo)&&this.log(`阵容信息异常: ${JSON.stringify(o)}`,"warning");const r=(i=o==null?void 0:o.presetTeamInfo)==null?void 0:i.useTeamId;return this.log(`当前阵容: ${r}`),r===m?(this.log(`当前已是${c}${m}，无需切换`,"success"),!1):(this.log(`当前阵容: ${r}, 目标阵容: ${m}，开始切换...`),await this.executeGameCommand(a,"presetteam_saveteam",{teamId:m},`切换到${c}${m}`),this.log(`成功切换到${c}${m}`,"success"),!0)}catch(o){this.log(`阵容检查失败，尝试强制切换: ${o.message}`,"warning");try{return await this.executeGameCommand(a,"presetteam_saveteam",{teamId:m},`强制切换到${c}${m}`),!0}catch(r){throw this.log(`强制切换也失败: ${r.message}`,"error"),r}}}loadSettings(a){try{const m=localStorage.getItem(`daily-settings:${a}`),c={arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0};return m?{...c,...JSON.parse(m)}:c}catch(m){return console.error("Failed to load settings:",m),null}}async run(a,m={},c=null){var _,C,S;this.callbacks=m;const i=c||this.loadSettings(a);this.log("正在获取角色信息...");let o;try{o=await this.tokenStore.sendGetRoleInfo(a),this.log("角色信息获取成功","success")}catch(e){throw this.log(`获取角色信息失败: ${e.message}`,"error"),e}const r=o==null?void 0:o.role;if(!r)throw new Error("角色数据不存在");this.log("开始执行每日任务补差");const u=((_=r.dailyTask)==null?void 0:_.complete)??{},h=e=>u[e]===-1,y=r.statistics??{},x=r.statisticsTime??{},s=[];if(h(2)||s.push({name:"分享一次游戏",execute:()=>this.executeGameCommand(a,"system_mysharecallback",{isSkipShareCard:!0,type:2},"分享游戏")}),h(3)||s.push({name:"赠送好友金币",execute:()=>this.executeGameCommand(a,"friend_batch",{},"赠送好友金币")}),h(4)||(s.push({name:"免费招募",execute:()=>this.executeGameCommand(a,"hero_recruit",{recruitType:3,recruitNumber:1},"免费招募")}),i.payRecruit&&s.push({name:"付费招募",execute:()=>this.executeGameCommand(a,"hero_recruit",{recruitType:1,recruitNumber:1},"付费招募")})),!h(6)&&f(x["buy:gold"]))for(let e=0;e<3;e++)s.push({name:`免费点金 ${e+1}/3`,execute:()=>this.executeGameCommand(a,"system_buygold",{buyNum:1},`免费点金 ${e+1}`)});if(!h(5)&&i.claimHangUp){s.push({name:"领取挂机奖励",execute:()=>this.executeGameCommand(a,"system_claimhangupreward",{},"领取挂机奖励")});for(let e=0;e<4;e++)s.push({name:`挂机加钟 ${e+1}/4`,execute:()=>this.executeGameCommand(a,"system_mysharecallback",{isSkipShareCard:!0,type:2},`挂机加钟 ${e+1}`)})}if(!h(7)&&i.openBox&&s.push({name:"开启木质宝箱",execute:()=>this.executeGameCommand(a,"item_openbox",{itemId:2001,number:10},"开启木质宝箱10个")}),s.push({name:"停止盐罐计时",execute:()=>this.executeGameCommand(a,"bottlehelper_stop",{},"停止盐罐计时")}),s.push({name:"开始盐罐计时",execute:()=>this.executeGameCommand(a,"bottlehelper_start",{},"开始盐罐计时")}),!h(14)&&i.claimBottle&&s.push({name:"领取盐罐奖励",execute:()=>this.executeGameCommand(a,"bottlehelper_claim",{},"领取盐罐奖励")}),!h(13)&&i.arenaEnable&&s.push({name:"竞技场战斗",execute:async()=>{this.log("开始竞技场战斗流程");const e=new Date().getHours();if(e<6){this.log("当前时间未到6点，跳过竞技场战斗","warning");return}if(e>22){this.log("当前时间已过22点，跳过竞技场战斗","warning");return}await this.switchToFormationIfNeeded(a,i.arenaFormation,"竞技场阵容"),await this.executeGameCommand(a,"arena_startarea",{},"开始竞技场");for(let n=1;n<=3;n++){this.log(`竞技场战斗 ${n}/3`);let l;try{l=await this.executeGameCommand(a,"arena_getareatarget",{},`获取竞技场目标${n}`)}catch(g){this.log(`竞技场战斗${n} - 获取对手失败: ${g.message}`,"error");break}const p=T(l);p?await this.executeGameCommand(a,"fight_startareaarena",{targetId:p},`竞技场战斗${n}`,1e4):this.log(`竞技场战斗${n} - 未找到目标: ${JSON.stringify(l)}`,"warning"),await new Promise(g=>setTimeout(g,1e3))}}}),i.bossTimes>0){let e=y["legion:boss"]??0;f(x["legion:boss"])&&(e=0);const n=Math.max(i.bossTimes-e,0);if(n>0){s.push({name:"军团BOSS阵容检查",execute:()=>this.switchToFormationIfNeeded(a,i.bossFormation,"BOSS阵容")});for(let l=0;l<n;l++)s.push({name:`军团BOSS ${l+1}/${n}`,execute:()=>this.executeGameCommand(a,"fight_startlegionboss",{},`军团BOSS ${l+1}`,12e3)})}}const G=B();s.push({name:"每日BOSS阵容检查",execute:()=>this.switchToFormationIfNeeded(a,i.bossFormation,"BOSS阵容")});for(let e=0;e<3;e++)s.push({name:`每日BOSS ${e+1}/3`,execute:()=>this.executeGameCommand(a,"fight_startboss",{bossId:G},`每日BOSS ${e+1}`,12e3)});const w=[{name:"福利签到",cmd:"system_signinreward"},{name:"俱乐部",cmd:"legion_signin"},{name:"领取每日礼包",cmd:"discount_claimreward"},{name:"领取每日免费奖励",cmd:"collection_claimfreereward"},{name:"领取免费礼包",cmd:"card_claimreward"},{name:"领取永久卡礼包",cmd:"card_claimreward",params:{cardId:4003}}];if(i.claimEmail&&w.push({name:"领取邮件奖励",cmd:"mail_claimallattachment"}),w.forEach(e=>{s.push({name:e.name,execute:()=>this.executeGameCommand(a,e.cmd,e.params||{},e.name)})}),s.push({name:"开始领取珍宝阁礼包",execute:()=>this.executeGameCommand(a,"collection_goodslist",{},"开始领取珍宝阁礼包")}),s.push({name:"领取珍宝阁免费礼包",execute:()=>this.executeGameCommand(a,"collection_claimfreereward",{},"领取珍宝阁免费礼包")}),f(y["artifact:normal:lottery:time"]))for(let e=0;e<3;e++)s.push({name:`免费钓鱼 ${e+1}/3`,execute:()=>this.executeGameCommand(a,"artifact_lottery",{lotteryNumber:1,newFree:!0,type:1},`免费钓鱼 ${e+1}`)});const $=["魏国","蜀国","吴国","群雄"];for(let e=1;e<=4;e++)f(x[`genie:daily:free:${e}`])&&s.push({name:`${$[e-1]}灯神免费扫荡`,execute:()=>this.executeGameCommand(a,"genie_sweep",{genieId:e},`${$[e-1]}灯神免费扫荡`)});for(let e=0;e<3;e++)s.push({name:`领取免费扫荡卷 ${e+1}/3`,execute:()=>this.executeGameCommand(a,"genie_buysweep",{},`领取免费扫荡卷 ${e+1}`)});!h(12)&&i.blackMarketPurchase&&s.push({name:"黑市购买1次物品",execute:()=>this.executeGameCommand(a,"store_purchase",{goodsId:1},"黑市购买1次物品")});const d=new Date().getDay();if(d===0|d===1|d===3|d===4){const e={0:107};s.push({name:"咸王梦境",execute:()=>this.executeGameCommand(a,"dungeon_selecthero",{battleTeam:e},"咸王梦境")})}d===1&&f(x["genie:daily:free:5"])&&s.push({name:"深海灯神",execute:()=>this.executeGameCommand(a,"genie_sweep",{genieId:5,sweepCnt:1},"深海灯神")});for(let e=1;e<=10;e++)s.push({name:`领取任务奖励${e}`,execute:()=>this.executeGameCommand(a,"task_claimdailypoint",{taskId:e},`领取任务奖励${e}`,5e3)});s.push({name:"领取日常任务奖励",execute:()=>this.executeGameCommand(a,"task_claimdailyreward",{},"领取日常任务奖励")},{name:"领取周常任务奖励",execute:()=>this.executeGameCommand(a,"task_claimweekreward",{},"领取周常任务奖励")},{name:"领取通行证奖励",execute:()=>this.executeGameCommand(a,"activity_recyclewarorderrewardclaim",{actId:1},"领取通行证奖励")});const b=s.length;this.log(`共有 ${b} 个任务待执行`);for(let e=0;e<s.length;e++){const n=s[e];try{await n.execute();const l=Math.floor((e+1)/b*100);(C=this.callbacks)!=null&&C.onProgress&&this.callbacks.onProgress(l),await new Promise(p=>setTimeout(p,500))}catch(l){this.log(`任务执行失败: ${n.name} - ${l.message}`,"error")}}(S=this.callbacks)!=null&&S.onProgress&&this.callbacks.onProgress(100),this.log("所有任务执行完成","success")}}export{O as D};
