import{s as useTokenStore,p as useMessage,n as computed,r as ref,v as reactive,x as watch,o as onMounted,Z as onBeforeUnmount,R as nextTick,c as createElementBlock,a as createBaseVNode,b as createVNode,w as withCtx,d as resolveComponent,i as openBlock,j as createTextVNode,t as toDisplayString,F as Fragment,g as renderList,e as createBlock,B as withModifiers,u as unref,I as normalizeStyle,z as normalizeClass,y as createCommentVNode,a1 as preloadQuestions}from"./index-COVLnS54.js";import{D as DailyTaskRunner}from"./dailyTaskRunner-DUQRdT4R.js";import{_ as _export_sfc}from"./plugin-vue_export-helper-DlAUqK2U.js";import{S as Settings}from"./Settings-TTw73EC_.js";const _hoisted_1={class:"batch-daily-tasks"},_hoisted_2={class:"main-layout"},_hoisted_3={class:"left-column"},_hoisted_4={class:"page-header"},_hoisted_5={class:"actions"},_hoisted_6={class:"token-row"},_hoisted_7={class:"token-item"},_hoisted_8={class:"task-preview",style:{margin:"16px 0",padding:"16px",border:"1px solid #e5e7eb","border-radius":"8px","background-color":"#fafafa"}},_hoisted_9={key:0,style:{display:"flex","flex-direction":"column","align-items":"center",padding:"12px","background-color":"white","border-radius":"6px","box-shadow":"0 2px 8px rgba(0, 0, 0, 0.1)"}},_hoisted_10={style:{"font-size":"16px","font-weight":"bold","margin-bottom":"8px"}},_hoisted_11={key:1,style:{"text-align":"center",padding:"24px",color:"#6b7280","font-style":"italic"}},_hoisted_12={key:0,class:"tasks-count"},_hoisted_13={key:1,class:"tasks-count"},_hoisted_14={class:"right-column"},_hoisted_15={class:"log-header-controls"},_hoisted_16={class:"time"},_hoisted_17={class:"message"},_hoisted_18={class:"settings-content"},_hoisted_19={class:"settings-grid"},_hoisted_20={class:"setting-item"},_hoisted_21={class:"setting-item"},_hoisted_22={class:"setting-item"},_hoisted_23={class:"setting-switches"},_hoisted_24={class:"switch-row"},_hoisted_25={class:"switch-row"},_hoisted_26={class:"switch-row"},_hoisted_27={class:"switch-row"},_hoisted_28={class:"switch-row"},_hoisted_29={class:"switch-row"},_hoisted_30={class:"switch-row"},_hoisted_31={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_32={class:"settings-content"},_hoisted_33={class:"settings-grid"},_hoisted_34={key:0,class:"setting-item"},_hoisted_35={key:1,class:"setting-item"},_hoisted_36={class:"setting-item"},_hoisted_37={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},_hoisted_38={class:"tasks-list",style:{"max-height":"600px","overflow-y":"auto"}},_hoisted_39={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"8px"}},_hoisted_40={style:{"font-weight":"bold"}},_hoisted_41={style:{"margin-bottom":"4px"}},_hoisted_42={style:{"margin-bottom":"4px"}},_hoisted_43={style:{"margin-bottom":"4px"}},_hoisted_44={style:{"margin-bottom":"4px"}},_hoisted_45={style:{"margin-bottom":"8px"}},_hoisted_46={style:{display:"flex",gap:"8px"}},_hoisted_47={key:0,style:{"text-align":"center",padding:"24px",color:"#6b7280"}},_hoisted_48={class:"settings-content"},_hoisted_49={class:"settings-grid"},_hoisted_50={class:"setting-item"},_hoisted_51={class:"setting-item"},_hoisted_52={key:0,class:"setting-item"},_hoisted_53={key:1,class:"setting-item"},_hoisted_54={class:"setting-item"},_hoisted_55={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"8px"}},_hoisted_56={class:"setting-item"},_hoisted_57={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"8px"}},_hoisted_58={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},FISH_TARGET=320,ARENA_TARGET=240,FOUR_HOURS_MS=4*60*60*1e3,_sfc_main={__name:"BatchDailyTasks",setup(__props){const tokenStore=useTokenStore(),message=useMessage(),runner=new DailyTaskRunner(tokenStore),tokens=computed(()=>tokenStore.gameTokens),isCarActivityOpen=computed(()=>{const t=new Date().getDay();return t>=1&&t<=3}),ismengjingActivityOpen=computed(()=>{const t=new Date().getDay();return t===0||t===1||t===3||t===4}),isbaokuActivityOpen=computed(()=>{const t=new Date().getDay();return t!=1&&t!=2}),isarenaActivityOpen=computed(()=>{const t=new Date().getHours();return t>=6&&t<22}),getCurrentActivityWeek=computed(()=>{const t=new Date,e=new Date("2025-12-12T12:00:00"),a=7*24*60*60*1e3,n=3*a,s=t-e;if(s<0)return null;const o=s%n;return o<a?"黑市周":o<2*a?"招募周":"宝箱周"}),isWeirdTowerActivityOpen=computed(()=>getCurrentActivityWeek.value==="黑市周"),selectedTokens=ref([]),tokenStatus=ref({}),isRunning=ref(!1),shouldStop=ref(!1),showSettingsModal=ref(!1),currentSettingsTokenId=ref(null),currentSettingsTokenName=ref(""),currentSettings=reactive({arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0}),showHelperModal=ref(!1),helperType=ref("box"),helperSettings=reactive({boxType:2001,fishType:1,count:100}),helperModalTitle=computed(()=>({box:"批量开宝箱",fish:"批量钓鱼",recruit:"批量招募"})[helperType.value]||"批量助手"),scheduledTasks=ref([]),showTaskModal=ref(!1),showTasksModal=ref(!1),editingTask=ref(null),taskForm=reactive({name:"",runType:"daily",runTime:null,cronExpression:"",selectedTokens:[],selectedTasks:[],enabled:!0}),availableTasks=[{label:"日常任务",value:"startBatch"},{label:"领取挂机",value:"claimHangUpRewards"},{label:"一键加钟",value:"batchAddHangUpTime"},{label:"重置罐子",value:"resetBottles"},{label:"一键领取罐子",value:"batchlingguanzi"},{label:"一键爬塔",value:"climbTower"},{label:"一键答题",value:"batchStudy"},{label:"智能发车",value:"batchSmartSendCar"},{label:"一键收车",value:"batchClaimCars"},{label:"批量开箱",value:"batchOpenBox"},{label:"领取宝箱积分",value:"batchClaimBoxPointReward"},{label:"批量钓鱼",value:"batchFish"},{label:"批量招募",value:"batchRecruit"},{label:"一键宝库前3层",value:"batchbaoku13"},{label:"一键宝库4,5层",value:"batchbaoku45"},{label:"一键梦境",value:"batchmengjing"},{label:"一键俱乐部签到",value:"batchclubsign"},{label:"一键竞技场战斗3次",value:"batcharenafight"},{label:"一键钓鱼补齐",value:"batchTopUpFish"},{label:"一键竞技场补齐",value:"batchTopUpArena"},{label:"一键领取怪异塔免费道具",value:"batchClaimFreeEnergy"},{label:"一键购买四圣碎片",value:"legion_storebuygoods"},{label:"一键黑市采购",value:"store_purchase"},{label:"免费领取珍宝阁",value:"collection_claimfreereward"}],loadScheduledTasks=()=>{try{const t=localStorage.getItem("scheduledTasks");if(console.log("Raw localStorage data:",t),t){const e=JSON.parse(t);console.log("Parsed data:",e),console.log("Is array:",Array.isArray(e)),scheduledTasks.value=Array.isArray(e)?e:[],console.log("Loaded scheduled tasks:",scheduledTasks.value),console.log("Loaded tasks count:",scheduledTasks.value.length)}else console.log("No saved tasks in localStorage"),scheduledTasks.value=[]}catch(t){console.error("Failed to load scheduled tasks:",t),scheduledTasks.value=[]}},saveScheduledTasks=()=>{try{const t=JSON.stringify(scheduledTasks.value);console.log("Saving to localStorage:",t),localStorage.setItem("scheduledTasks",t);const e=localStorage.getItem("scheduledTasks");console.log("Verified saved data:",e),console.log("Saved scheduled tasks:",scheduledTasks.value),console.log("Saved tasks count:",scheduledTasks.value.length)}catch(t){console.error("Failed to save scheduled tasks:",t)}},openTaskModal=()=>{editingTask.value=null,Object.assign(taskForm,{name:"",runType:"daily",runTime:void 0,cronExpression:"",selectedTokens:[],selectedTasks:[],enabled:!0}),showTaskModal.value=!0},editTask=t=>{editingTask.value=t;const e={...t};if(t.runType==="daily"&&t.runTime&&typeof t.runTime=="string"){const[a,n]=t.runTime.split(":").map(Number),s=new Date;e.runTime=new Date(s.getFullYear(),s.getMonth(),s.getDate(),a,n)}Object.assign(taskForm,e),showTaskModal.value=!0},validateCronExpression=t=>{if(!t)return{valid:!1,message:"Cron表达式不能为空"};const e=t.split(" ").filter(Boolean);if(e.length!==5)return{valid:!1,message:"Cron表达式必须包含5个字段：分 时 日 月 周"};const[a,n,s,o,u]=e,r=(m,T,p,v)=>{if(!new RegExp("^(?:\\*|\\*/\\d+|[0-9]+/\\d+|(?:[0-9]+-?)*[0-9]+(?:,[0-9]+-?)*[0-9]+(?:/\\d+)?)$").test(m))return{valid:!1,message:`${v}字段格式错误`};if(/^\d+$/.test(m)){const f=parseInt(m);if(f<T||f>p)return{valid:!1,message:`${v}字段必须在${T}-${p}之间`}}return{valid:!0}},c=r(a,0,59,"分钟");if(!c.valid)return c;const l=r(n,0,23,"小时");if(!l.valid)return l;const k=r(s,1,31,"日期");if(!k.valid)return k;const d=r(o,1,12,"月份");if(!d.valid)return d;const g=r(u,0,7,"星期");return g.valid?{valid:!0,message:"Cron表达式格式正确"}:g},saveTask=()=>{var n;if(!taskForm.name){message.warning("请输入任务名称");return}if(taskForm.runType==="daily"&&!taskForm.runTime){message.warning("请选择运行时间");return}if(taskForm.runType==="cron"){if(!taskForm.cronExpression){message.warning("请输入Cron表达式");return}const s=validateCronExpression(taskForm.cronExpression);if(!s.valid){message.warning(s.message);return}}if(taskForm.selectedTokens.length===0){message.warning("请选择至少一个账号");return}if(taskForm.selectedTasks.length===0){message.warning("请选择至少一个任务");return}let t=null;taskForm.runType==="daily"&&taskForm.runTime&&(t=new Date(taskForm.runTime).toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit"}));const e={id:((n=editingTask.value)==null?void 0:n.id)||"task_"+Date.now(),name:taskForm.name,runType:taskForm.runType,runTime:t,cronExpression:taskForm.runType==="cron"?taskForm.cronExpression:"",selectedTokens:[...taskForm.selectedTokens],selectedTasks:[...taskForm.selectedTasks],enabled:taskForm.enabled};let a=!editingTask.value;if(editingTask.value){const s=scheduledTasks.value.findIndex(o=>o.id===editingTask.value.id);s!==-1&&(scheduledTasks.value[s]=e)}else scheduledTasks.value.push(e);saveScheduledTasks(),console.log("After saving task, scheduledTasks.length:",scheduledTasks.value.length),console.log("Scheduled tasks:",scheduledTasks.value),addTaskSaveLog(e,a),showTaskModal.value=!1,message.success("定时任务已保存")},deleteTask=t=>{const e=scheduledTasks.value.find(a=>a.id===t);e&&(scheduledTasks.value=scheduledTasks.value.filter(a=>a.id!==t),saveScheduledTasks(),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${e.name} 已删除 ===`,type:"info"}),message.success("定时任务已删除"))},toggleTaskEnabled=(t,e)=>{const a=scheduledTasks.value.find(n=>n.id===t);a&&(a.enabled=e,saveScheduledTasks(),message.success(`定时任务已${e?"启用":"禁用"}`),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${a.name} 已${e?"启用":"禁用"} ===`,type:"info"}))},addTaskSaveLog=(t,e)=>{addLog({time:new Date().toLocaleTimeString(),message:`=== ${e?"新增":"修改"}定时任务: ${t.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`运行类型: ${t.runType==="daily"?"每天固定时间":"Cron表达式"}`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`运行时间: ${t.runType==="daily"?t.runTime:t.cronExpression}`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`选中账号: ${t.selectedTokens.length} 个`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`选中任务: ${t.selectedTasks.length} 个`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`状态: ${t.enabled?"启用":"禁用"}`,type:"info"})},resetRunType=()=>{taskForm.runType==="daily"?taskForm.cronExpression="":taskForm.runTime=void 0},selectAllTokens=()=>{taskForm.selectedTokens=tokens.value.map(t=>t.id)},deselectAllTokens=()=>{taskForm.selectedTokens=[]},selectAllTasks=()=>{taskForm.selectedTasks=availableTasks.map(t=>t.value)},deselectAllTasks=()=>{taskForm.selectedTasks=[]},legion_storebuygoods=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始购买四圣碎片: ${e.name} ===`,type:"info"}),await ensureConnection(t),addLog({time:new Date().toLocaleTimeString(),message:"发送购买请求...",type:"info"});const a=await tokenStore.sendMessageWithPromise(t,"legion_storebuygoods",{id:6},5e3);await new Promise(n=>setTimeout(n,500)),a.error?a.error.includes("俱乐部商品购买数量超出上限")?addLog({time:new Date().toLocaleTimeString(),message:"本周已购买过四圣碎片，跳过",type:"info"}):a.error.includes("物品不存在")?(addLog({time:new Date().toLocaleTimeString(),message:"盐锭不足或未加入军团，购买失败",type:"error"}),tokenStatus.value[t]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:`购买失败: ${a.error}`,type:"error"}),tokenStatus.value[t]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:"购买成功，获得四圣碎片",type:"success"}),tokenStatus.value[t]="completed"),currentProgress.value=100}catch(a){addLog({time:new Date().toLocaleTimeString(),message:`购买过程出错: ${a.message}`,type:"error"}),tokenStatus.value[t]="failed"}finally{await new Promise(a=>setTimeout(a,1e3))}}currentRunningTokenId.value=null,isRunning.value=!1,shouldStop.value=!1}},collection_claimfreereward=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始免费领取珍宝阁: ${e.name} ===`,type:"info"}),await ensureConnection(t),addLog({time:new Date().toLocaleTimeString(),message:"发送珍宝阁免费领取请求...",type:"info"});const a=await tokenStore.sendMessageWithPromise(t,"collection_claimfreereward",{},5e3);await new Promise(n=>setTimeout(n,500)),a.error?(addLog({time:new Date().toLocaleTimeString(),message:`珍宝阁领取失败: ${a.error}`,type:"error"}),tokenStatus.value[t]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:"珍宝阁领取成功",type:"success"}),tokenStatus.value[t]="completed"),currentProgress.value=100}catch(a){addLog({time:new Date().toLocaleTimeString(),message:`珍宝阁领取过程出错: ${a.message}`,type:"error"}),tokenStatus.value[t]="failed"}finally{await new Promise(a=>setTimeout(a,1e3))}}currentRunningTokenId.value=null,isRunning.value=!1,shouldStop.value=!1}},store_purchase=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始黑市一键采购: ${e.name} ===`,type:"info"}),await ensureConnection(t),addLog({time:new Date().toLocaleTimeString(),message:"发送黑市采购请求...",type:"info"});const a=await tokenStore.sendMessageWithPromise(t,"store_purchase",{},5e3);await new Promise(n=>setTimeout(n,500)),a.error?(addLog({time:new Date().toLocaleTimeString(),message:`黑市采购失败: ${a.error}`,type:"error"}),tokenStatus.value[t]="failed"):(addLog({time:new Date().toLocaleTimeString(),message:"黑市采购成功",type:"success"}),tokenStatus.value[t]="completed"),currentProgress.value=100}catch(a){addLog({time:new Date().toLocaleTimeString(),message:`黑市采购过程出错: ${a.message}`,type:"error"}),tokenStatus.value[t]="failed"}finally{await new Promise(a=>setTimeout(a,1e3))}}currentRunningTokenId.value=null,isRunning.value=!1,shouldStop.value=!1}},parseCronField=(t,e,a)=>{const n=new Set;if(t==="*"){for(let s=e;s<=a;s++)n.add(s);return Array.from(n)}if(t.includes("/")){const[s,o]=t.split("/"),u=parseInt(o);let r=e,c=a;if(s!=="*")if(s.includes("-")){const[l,k]=s.split("-").map(Number);r=l,c=k}else r=parseInt(s),c=a;for(let l=r;l<=c;l+=u)n.add(l);return Array.from(n)}if(t.includes("-")){const[s,o]=t.split("-").map(Number);for(let u=s;u<=o;u++)n.add(u);return Array.from(n)}if(t.includes(",")){const s=t.split(",");for(const o of s)n.add(parseInt(o));return Array.from(n)}return[parseInt(t)]},calculateNextExecutionTime=t=>{const e=new Date;if(t.runType==="daily"){const[a,n]=t.runTime.split(":").map(Number),s=new Date(e);return s.setHours(a,n,0,0),s<=e&&s.setDate(s.getDate()+1),s}else if(t.runType==="cron"){const a=t.cronExpression.split(" ").filter(Boolean);if(a.length<5)return null;const[n,s,o,u,r]=a,c=parseCronField(n,0,59),l=parseCronField(s,0,23),k=parseCronField(o,1,31),d=parseCronField(u,1,12),g=parseCronField(r,0,7);let m=new Date(e);m.setSeconds(0,0),m.setMinutes(m.getMinutes()+1);const T=new Date(e);for(T.setFullYear(T.getFullYear()+1);m<=T;){const p=m.getMinutes(),v=m.getHours(),w=m.getDate(),f=m.getMonth()+1,L=m.getDay();if(c.includes(p)&&l.includes(v)&&k.includes(w)&&d.includes(f)&&g.includes(L))return m;m.setMinutes(m.getMinutes()+1)}return null}return null},formatTimeDifference=t=>{const e=Math.floor(t/1e3),a=Math.floor(e/60),n=Math.floor(a/60),s=Math.floor(n/24),o=n%24,u=a%60,r=e%60;let c="";return s>0&&(c+=`${s}天`),(o>0||s>0)&&(c+=`${o}小时`),(u>0||o>0||s>0)&&(c+=`${u}分`),c+=`${r}秒`,c},taskCountdowns=ref({}),nextExecutionTimes=ref({}),updateCountdowns=()=>{const t=Date.now();scheduledTasks.value.forEach(e=>{if((!nextExecutionTimes.value[e.id]||nextExecutionTimes.value[e.id]<=t)&&(nextExecutionTimes.value[e.id]=calculateNextExecutionTime(e)),nextExecutionTimes.value[e.id]){const a=nextExecutionTimes.value[e.id]-t;taskCountdowns.value[e.id]={remainingTime:Math.max(0,a),formatted:formatTimeDifference(Math.max(0,a)),isNearExecution:a<5*60*1e3}}})},shortestCountdownTask=computed(()=>{if(scheduledTasks.value.length===0)return null;let t=null,e=1/0;return scheduledTasks.value.forEach(a=>{const n=taskCountdowns.value[a.id];n&&n.remainingTime<e&&(e=n.remainingTime,t={task:a,countdown:n})}),t});let countdownInterval=null;const startCountdown=()=>{countdownInterval&&clearInterval(countdownInterval),updateCountdowns(),countdownInterval=setInterval(updateCountdowns,1e3)};loadScheduledTasks(),watch(scheduledTasks,t=>{console.log("scheduledTasks changed:",t.length),console.log("New value:",t),nextExecutionTimes.value={},taskCountdowns.value={},updateCountdowns()},{deep:!0}),watch(()=>showTaskModal.value,t=>{t&&!taskForm.runTime&&(taskForm.runTime=void 0)}),onMounted(()=>{console.log("Component mounted, initial scheduledTasks:",scheduledTasks.value),console.log("Initial scheduledTasks length:",scheduledTasks.value.length),scheduleTaskExecution(),startCountdown()}),onBeforeUnmount(()=>{countdownInterval&&(clearInterval(countdownInterval),countdownInterval=null)});const scheduleTaskExecution=()=>{addLog({time:new Date().toLocaleTimeString(),message:"=== 定时任务调度服务已启动 ===",type:"info"});let t=null,e=null;const a=()=>{if(console.log(`[${new Date().toISOString()}] Task scheduler health check - running: ${t!==null}`),t||(console.error(`[${new Date().toISOString()}] Task scheduler interval is not running, restarting...`),n()),isRunning.value){const o=Date.now()-10*60*1e3;e&&e<o&&(console.error(`[${new Date().toISOString()}] isRunning has been true for more than 10 minutes, resetting to false`),isRunning.value=!1,addLog({time:new Date().toLocaleTimeString(),message:"=== 检测到任务执行超时，已重置isRunning状态 ===",type:"warning"}))}},n=()=>{t&&clearInterval(t),t=setInterval(()=>{try{const s=new Date,o=s.toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"});console.log(`[${new Date().toISOString()}] Checking scheduled tasks...`);const u=scheduledTasks.value.filter(r=>r.enabled);if(u.length===0){console.log(`[${new Date().toISOString()}] No enabled tasks to check`);return}u.forEach(r=>{let c=!1,l="";if(r.runType==="daily"){const k=r.runTime,d=s.toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit"});c=d===k,l=`currentTime=${d}, taskTime=${k}, match=${c}`}else if(r.runType==="cron")try{const k=r.cronExpression.split(" ").filter(Boolean);if(k.length<5){console.error(`[${new Date().toISOString()}] Invalid cron expression: ${r.cronExpression}, must have at least 5 parts`),addLog({time:o,message:`=== 定时任务 ${r.name} 的Cron表达式无效: ${r.cronExpression}，必须包含至少5个字段 ===`,type:"error"});return}const[d,g,m,T,p]=k,v=parseCronField(d,0,59),w=parseCronField(g,0,23),f=parseCronField(m,1,31),L=parseCronField(T,1,12),i=parseCronField(p,0,7),b=v.includes(s.getMinutes()),y=w.includes(s.getHours()),S=f.includes(s.getDate()),x=L.includes(s.getMonth()+1),h=i.includes(s.getDay());c=b&&y&&S&&x&&h,l=`minute=${b}, hour=${y}, dayOfMonth=${S}, month=${x}, dayOfWeek=${h}`}catch(k){console.error(`[${new Date().toISOString()}] Error parsing cron expression ${r.cronExpression}:`,k),addLog({time:o,message:`=== 解析定时任务 ${r.name} 的Cron表达式失败: ${k.message} ===`,type:"error"});return}if(console.log(`[${new Date().toISOString()}] Task ${r.name}: shouldRun=${c}, reason=${l}`),c){const k=`${r.id}_${s.getDate()}_${s.getHours()}_${s.getMinutes()}`;localStorage.getItem(`lastTaskExecution_${r.id}`)!==k?(localStorage.setItem(`lastTaskExecution_${r.id}`,k),console.log(`[${new Date().toISOString()}] Executing task ${r.name}`),e=Date.now(),executeScheduledTask(r)):(console.log(`[${new Date().toISOString()}] Task ${r.name} already executed in this minute, skipping`),addLog({time:o,message:`=== 任务 ${r.name} 本分钟内已执行，跳过 ===`,type:"info"}))}})}catch(s){console.error(`[${new Date().toISOString()}] Error in task scheduler:`,s),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务调度服务发生错误: ${s.message} ===`,type:"error"})}},1e4),console.log(`[${new Date().toISOString()}] Task scheduler started with interval ID: ${t}`)};n(),setInterval(a,5*60*1e3),a(),onBeforeUnmount(()=>{console.log(`[${new Date().toISOString()}] Cleaning up task scheduler...`),t&&(clearInterval(t),t=null),addLog({time:new Date().toLocaleTimeString(),message:"=== 定时任务调度服务已停止 ===",type:"info"})})},verifyTaskDependencies=async task=>{var t;addLog({time:new Date().toLocaleTimeString(),message:`=== 开始验证定时任务 ${task.name} 的依赖 ===`,type:"info"});try{localStorage.setItem("test","test"),localStorage.removeItem("test"),addLog({time:new Date().toLocaleTimeString(),message:"✅ localStorage可用",type:"info"})}catch(e){return addLog({time:new Date().toLocaleTimeString(),message:`❌ localStorage不可用: ${e.message}`,type:"error"}),!1}if(!tokenStore||!tokenStore.gameTokens)return addLog({time:new Date().toLocaleTimeString(),message:"❌ Token存储不可用",type:"error"}),!1;for(const taskName of task.selectedTasks){const taskFunction=eval(taskName);if(typeof taskFunction!="function")return addLog({time:new Date().toLocaleTimeString(),message:`❌ 任务函数不存在: ${taskName}`,type:"error"}),!1}const checkWebSocketWithRetry=async(e,a=3,n=1e3)=>{var s;for(let o=0;o<a;o++){if(tokenStore.getWebSocketStatus(e)==="connected")return!0;if(o<a){const r=((s=tokenStore.gameTokens.find(c=>c.id===e))==null?void 0:s.name)||e;try{addLog({time:new Date().toLocaleTimeString(),message:`⏳ 账号 ${r} WebSocket未连接，尝试手动连接... (${o+1}/${a})`,type:"warning"});const c=tokenStore.gameTokens.find(l=>l.id===e);if(c&&c.token)typeof tokenStore.createWebSocketConnection=="function"?tokenStore.createWebSocketConnection(e,c.token):typeof tokenStore.selectToken=="function"&&tokenStore.selectToken(e,!0),await new Promise(l=>setTimeout(l,n));else{addLog({time:new Date().toLocaleTimeString(),message:`⚠️  账号 ${r} 缺少token信息，无法尝试手动连接`,type:"warning"});break}}catch(c){addLog({time:new Date().toLocaleTimeString(),message:`❌ 账号 ${r} 尝试手动连接失败: ${c.message}`,type:"error"}),await new Promise(l=>setTimeout(l,n))}}}return tokenStore.getWebSocketStatus(e)==="connected"},connectedTokens=[],disconnectedTokens=[];for(const e of task.selectedTokens){const a=((t=tokenStore.gameTokens.find(s=>s.id===e))==null?void 0:t.name)||e;await checkWebSocketWithRetry(e)?connectedTokens.push({id:e,name:a}):disconnectedTokens.push({id:e,name:a})}return connectedTokens.length>0&&addLog({time:new Date().toLocaleTimeString(),message:`✅ 已连接账号: ${connectedTokens.map(e=>e.name).join(", ")}`,type:"info"}),disconnectedTokens.length>0&&addLog({time:new Date().toLocaleTimeString(),message:`⚠️  未连接账号: ${disconnectedTokens.map(e=>e.name).join(", ")}`,type:"warning"}),connectedTokens.length===0?(addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${task.name} 没有可用的连接账号，取消执行 ===`,type:"error"}),!1):(task.connectedTokens=connectedTokens.map(e=>e.id),addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${task.name} 的依赖验证通过，将执行 ${connectedTokens.length} 个账号 ===`,type:"success"}),!0)},executeScheduledTask=async task=>{var t;addLog({time:new Date().toLocaleTimeString(),message:`=== 开始执行定时任务: ${task.name} ===`,type:"info"});try{const dependenciesValid=await verifyTaskDependencies(task);if(!dependenciesValid){addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务 ${task.name} 依赖验证失败，取消执行 ===`,type:"error"});return}selectedTokens.value=[...task.connectedTokens||task.selectedTokens];for(const taskName of task.selectedTasks){if(shouldStop.value)break;addLog({time:new Date().toLocaleTimeString(),message:`执行任务: ${((t=availableTasks.find(e=>e.value===taskName))==null?void 0:t.label)||taskName}`,type:"info"});const taskFunction=eval(taskName);typeof taskFunction=="function"?await taskFunction():addLog({time:new Date().toLocaleTimeString(),message:`任务函数不存在: ${taskName}`,type:"error"})}addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务执行完成: ${task.name} ===`,type:"success"})}catch(e){addLog({time:new Date().toLocaleTimeString(),message:`=== 定时任务执行失败: ${e.message} ===`,type:"error"}),console.error(`[${new Date().toISOString()}] Error executing scheduled task ${task.name}:`,e)}},boxTypeOptions=[{label:"木质宝箱",value:2001},{label:"青铜宝箱",value:2002},{label:"黄金宝箱",value:2003},{label:"铂金宝箱",value:2004}],fishTypeOptions=[{label:"普通鱼竿",value:1},{label:"黄金鱼竿",value:2}],openHelperModal=t=>{helperType.value=t,showHelperModal.value=!0},executeHelper=()=>{if(helperSettings.count%10!==0||helperSettings.count<10){message.warning("消耗数量必须是10的整数倍，最小为10");return}showHelperModal.value=!1,helperType.value==="box"?batchOpenBox():helperType.value==="fish"?batchFish():helperType.value==="recruit"&&batchRecruit()},formationOptions=[1,2,3,4,5,6].map(t=>({label:`阵容${t}`,value:t})),bossTimesOptions=[0,1,2,3,4].map(t=>({label:`${t}次`,value:t})),loadSettings=t=>{try{const e=localStorage.getItem(`daily-settings:${t}`),a={arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0};return e?{...a,...JSON.parse(e)}:a}catch(e){return console.error("Failed to load settings:",e),null}},openSettings=t=>{currentSettingsTokenId.value=t.id,currentSettingsTokenName.value=t.name;const e=loadSettings(t.id);Object.assign(currentSettings,e),showSettingsModal.value=!0},saveSettings=()=>{currentSettingsTokenId.value&&(localStorage.setItem(`daily-settings:${currentSettingsTokenId.value}`,JSON.stringify(currentSettings)),message.success(`已保存 ${currentSettingsTokenName.value} 的设置`),showSettingsModal.value=!1)},currentRunningTokenId=ref(null),currentProgress=ref(0),logs=ref([]),logContainer=ref(null),autoScrollLog=ref(!0),currentRunningTokenName=computed(()=>{const t=tokens.value.find(e=>e.id===currentRunningTokenId.value);return t?t.name:""}),isAllSelected=computed(()=>selectedTokens.value.length===tokens.value.length&&tokens.value.length>0),isIndeterminate=computed(()=>selectedTokens.value.length>0&&selectedTokens.value.length<tokens.value.length),handleSelectAll=t=>{t?selectedTokens.value=tokens.value.map(e=>e.id):selectedTokens.value=[]},getStatusType=t=>{const e=tokenStatus.value[t];return e==="completed"?"success":e==="failed"?"error":e==="running"?"info":"default"},getStatusText=t=>{const e=tokenStatus.value[t];return e==="completed"?"已完成":e==="failed"?"失败":e==="running"?"执行中":"等待中"},pickArenaTargetId=t=>{var a,n,s,o,u;const e=((a=t==null?void 0:t.rankList)==null?void 0:a[0])||((n=t==null?void 0:t.roleList)==null?void 0:n[0])||((s=t==null?void 0:t.targets)==null?void 0:s[0])||((o=t==null?void 0:t.targetList)==null?void 0:o[0])||((u=t==null?void 0:t.list)==null?void 0:u[0]);return e!=null&&e.roleId?e.roleId:e!=null&&e.id?e.id:(t==null?void 0:t.roleId)||(t==null?void 0:t.id)},getTodayStartSec=()=>{const t=new Date;return t.setHours(0,0,0,0),Math.floor(t.getTime()/1e3)},isTodayAvailable=t=>!t||typeof t!="number"?!0:t<getTodayStartSec(),calculateMonthProgress=()=>{const t=new Date,e=new Date(t.getFullYear(),t.getMonth()+1,0).getDate(),a=t.getDate();return Math.min(1,Math.max(0,a/e))},addLog=t=>{logs.value.push(t),nextTick(()=>{logContainer.value&&autoScrollLog.value&&(logContainer.value.scrollTop=logContainer.value.scrollHeight)})};watch(autoScrollLog,t=>{t&&logContainer.value&&nextTick(()=>{logContainer.value.scrollTop=logContainer.value.scrollHeight})});const copyLogs=()=>{if(logs.value.length===0){message.warning("没有可复制的日志");return}const t=logs.value.map(e=>`${e.time} ${e.message}`).join(`
`);navigator.clipboard.writeText(t).then(()=>{message.success("日志已复制到剪贴板")}).catch(e=>{message.error("复制日志失败: "+e.message)})},waitForConnection=async(t,e=2e3)=>{const a=Date.now();for(;Date.now()-a<e;){if(tokenStore.getWebSocketStatus(t)==="connected")return!0;await new Promise(s=>setTimeout(s,500))}return!1},resetBottles=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始重置罐子: ${e.name} ===`,type:"info"}),await ensureConnection(t),addLog({time:new Date().toLocaleTimeString(),message:"停止计时...",type:"info"}),await tokenStore.sendMessageWithPromise(t,"bottlehelper_stop",{},5e3),await new Promise(a=>setTimeout(a,500)),addLog({time:new Date().toLocaleTimeString(),message:"开始计时...",type:"info"}),await tokenStore.sendMessageWithPromise(t,"bottlehelper_start",{},5e3),tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 重置完成 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`重置失败: ${a.message}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量重置罐子结束")}},claimHangUpRewards=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始领取挂机: ${e.name} ===`,type:"info"}),await ensureConnection(t),addLog({time:new Date().toLocaleTimeString(),message:"领取挂机奖励",type:"info"}),await tokenStore.sendMessageWithPromise(t,"system_claimhangupreward",{},5e3),await new Promise(a=>setTimeout(a,500));for(let a=0;a<4;a++)addLog({time:new Date().toLocaleTimeString(),message:`挂机加钟 ${a+1}/4`,type:"info"}),await tokenStore.sendMessageWithPromise(t,"system_mysharecallback",{isSkipShareCard:!0,type:2},5e3),await new Promise(n=>setTimeout(n,500));tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 领取完成 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`领取失败: ${a.message}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取挂机结束")}},batchbaoku13=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键宝库: ${e.name} ===`,type:"info"}),await ensureConnection(t);const n=(await tokenStore.sendMessageWithPromise(t,"bosstower_getinfo",{})).bossTower.towerId;if(n>=1&&n<=3){for(let s=0;s<2&&!shouldStop.value;s++)await tokenStore.sendMessageWithPromise(t,"bosstower_startboss",{}),await new Promise(o=>setTimeout(o,500));for(let s=0;s<9&&!shouldStop.value;s++)await tokenStore.sendMessageWithPromise(t,"bosstower_startbox",{}),await new Promise(o=>setTimeout(o,500))}tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 宝库战斗已完成，请上线手动领取奖励 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`宝库战斗失败: ${a.message||"未知错误"}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量宝库结束")}},batchbaoku45=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键宝库: ${e.name} ===`,type:"info"}),await ensureConnection(t);const n=(await tokenStore.sendMessageWithPromise(t,"bosstower_getinfo",{})).bossTower.towerId;if(n>=4&&n<=5)for(let s=0;s<2&&!shouldStop.value;s++)await tokenStore.sendMessageWithPromise(t,"bosstower_startboss",{}),await new Promise(o=>setTimeout(o,500));tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 宝库战斗已完成 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`宝库战斗失败: ${a.message||"未知错误"}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量宝库结束")}},batchmengjing=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{if(addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键宝库: ${e.name} ===`,type:"info"}),await ensureConnection(t),shouldStop.value)break;const a={0:107},n=new Date().getDay();if(n===0|n===1|n===3|n===4)await tokenStore.sendMessageWithPromise(t,"dungeon_selecthero",{battleTeam:a},5e3),await new Promise(s=>setTimeout(s,500)),tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 咸王梦境已完成 ===`,type:"success"});else{addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 当前未在开放时间 ===`,type:"error"});break}}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`咸王梦境失败: ${a.message||"未知错误"}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量梦境结束")}},batchlingguanzi=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{if(addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键领取盐罐: ${e.name} ===`,type:"info"}),await ensureConnection(t),shouldStop.value)break;await tokenStore.sendMessageWithPromise(t,"bottlehelper_claim",{},5e3),await new Promise(a=>setTimeout(a,500)),tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 领取盐罐已完成 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`领取盐罐失败: ${a.message||"未知错误"}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取盐罐结束")}},batchclubsign=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{if(addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键俱乐部签到: ${e.name} ===`,type:"info"}),await ensureConnection(t),shouldStop.value)break;await tokenStore.sendMessageWithPromise(t,"legion_signin",{},5e3),await new Promise(a=>setTimeout(a,500)),tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 俱乐部签到已完成 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`俱乐部签到失败: ${a.message||"未知错误"}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量俱乐部签到结束")}},batcharenafight=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{if(addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键竞技场战斗: ${e.name} ===`,type:"info"}),await ensureConnection(t),shouldStop.value)break;for(let a=0;a<3;a++){await tokenStore.sendMessageWithPromise(t,"arena_startarea",{});let n;try{n=await tokenStore.sendMessageWithPromise(t,"arena_getareatarget",{})}catch(o){message.error(`获取竞技场目标失败：${o.message}`);break}const s=pickArenaTargetId(n);if(!s){addLog({time:new Date().toLocaleTimeString(),message:`未找到可用的竞技场目标: ${error.message||"未知错误"}`,type:"error"});break}try{await tokenStore.sendMessageWithPromise(t,"fight_startareaarena",{targetId:s}),addLog({time:new Date().toLocaleTimeString(),message:`${e.name} 竞技场战斗 ${a+1}/3`,type:"info"}),await new Promise(o=>setTimeout(o,500))}catch{addLog({time:new Date().toLocaleTimeString(),message:`竞技场对决失败: ${error.message||"未知错误"}`,type:"error"})}}await new Promise(a=>setTimeout(a,500)),tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 竞技场战斗已完成 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`竞技场战斗失败: ${a.message||"未知错误"}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量竞技场战斗结束")}},batchAddHangUpTime=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键加钟: ${e.name} ===`,type:"info"}),await ensureConnection(t);for(let a=0;a<4&&!shouldStop.value;a++)addLog({time:new Date().toLocaleTimeString(),message:`执行加钟 ${a+1}/4`,type:"info"}),await tokenStore.sendMessageWithPromise(t,"system_mysharecallback",{isSkipShareCard:!0,type:2},5e3),await new Promise(n=>setTimeout(n,500));tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 加钟完成 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`加钟失败: ${a.message||"未知错误"}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量加钟结束")}},ensureConnection=async t=>{var s;const e=tokens.value.find(o=>o.id===t);let n=tokenStore.getWebSocketStatus(t)==="connected";if(!n&&(addLog({time:new Date().toLocaleTimeString(),message:"正在连接...",type:"info"}),tokenStore.createWebSocketConnection(t,e.token,e.wsUrl),n=await waitForConnection(t),!n)){addLog({time:new Date().toLocaleTimeString(),message:"连接超时，尝试重连...",type:"warning"}),tokenStore.closeWebSocketConnection(t),await new Promise(u=>setTimeout(u,2e3)),addLog({time:new Date().toLocaleTimeString(),message:"正在重连...",type:"info"});const o=tokens.value.find(u=>u.id===t);tokenStore.createWebSocketConnection(t,o.token,o.wsUrl),n=await waitForConnection(t)}if(!n)throw new Error("连接失败 (重试后仍超时)");try{await tokenStore.sendMessageWithPromise(t,"role_getroleinfo",{},5e3);const o=await tokenStore.sendMessageWithPromise(t,"fight_startlevel",{},5e3);(s=o==null?void 0:o.battleData)!=null&&s.version&&tokenStore.setBattleVersion(o.battleData.version)}catch(o){addLog({time:new Date().toLocaleTimeString(),message:`初始化数据失败: ${o.message}`,type:"warning"})}return!0},climbTower=async()=>{var t,e,a,n,s,o,u,r,c;if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(l=>{tokenStatus.value[l]="waiting"});for(const l of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=l,tokenStatus.value[l]="running",currentProgress.value=0;const k=tokens.value.find(d=>d.id===l);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始爬塔: ${k.name} ===`,type:"info"}),await ensureConnection(l),await tokenStore.sendMessageWithPromise(l,"tower_getinfo",{},5e3).catch(()=>{});let d=await tokenStore.sendGetRoleInfo(l),g=((e=(t=d==null?void 0:d.role)==null?void 0:t.tower)==null?void 0:e.energy)||0;addLog({time:new Date().toLocaleTimeString(),message:`初始体力: ${g}`,type:"info"});let m=0;const T=100;let p=0;for(;g>0&&m<T&&!shouldStop.value;)try{await tokenStore.sendMessageWithPromise(l,"fight_starttower",{},5e3),m++,p=0,addLog({time:new Date().toLocaleTimeString(),message:`爬塔第 ${m} 次`,type:"info"}),await new Promise(w=>setTimeout(w,2e3)),tokenStore.sendMessage(l,"tower_getinfo"),d=await tokenStore.sendGetRoleInfo(l);const v=(a=tokenStore.gameData)==null?void 0:a.roleInfo;g=((s=(n=v==null?void 0:v.role)==null?void 0:n.tower)==null?void 0:s.energy)??((u=(o=d==null?void 0:d.role)==null?void 0:o.tower)==null?void 0:u.energy)??0}catch(v){if(v.message&&v.message.includes("200400")){addLog({time:new Date().toLocaleTimeString(),message:"爬塔次数已用完 (200400)",type:"info"});break}if(p++,addLog({time:new Date().toLocaleTimeString(),message:`战斗出错: ${v.message} (重试 ${p}/3)`,type:"warning"}),p>=3){addLog({time:new Date().toLocaleTimeString(),message:"连续失败次数过多，停止爬塔",type:"error"});break}await new Promise(w=>setTimeout(w,2e3));try{d=await tokenStore.sendGetRoleInfo(l),g=((c=(r=d==null?void 0:d.role)==null?void 0:r.tower)==null?void 0:c.energy)||0}catch{}}tokenStatus.value[l]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${k.name} 爬塔结束，共 ${m} 次 ===`,type:"success"})}catch(d){console.error(d),tokenStatus.value[l]="failed",addLog({time:new Date().toLocaleTimeString(),message:`爬塔失败: ${d.message}`,type:"error"})}currentProgress.value=100,await new Promise(d=>setTimeout(d,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量爬塔结束")}},batchStudy=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"}),addLog({time:new Date().toLocaleTimeString(),message:"正在加载题库...",type:"info"}),await preloadQuestions();for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始答题: ${e.name} ===`,type:"info"}),await ensureConnection(t),tokenStore.gameData.studyStatus={isAnswering:!1,questionCount:0,answeredCount:0,status:"",timestamp:null},await tokenStore.sendMessageWithPromise(t,"study_startgame",{},5e3);let a=90,n=!1,s="";for(;a>0&&!shouldStop.value;){const o=tokenStore.gameData.studyStatus;if(o.status!==s&&(s=o.status,o.status==="answering"?addLog({time:new Date().toLocaleTimeString(),message:"开始答题...",type:"info"}):o.status==="claiming_rewards"&&addLog({time:new Date().toLocaleTimeString(),message:"正在领取奖励...",type:"info"})),o.status==="answering"&&o.questionCount>0,o.status==="completed"){n=!0;break}await new Promise(u=>setTimeout(u,1e3)),a--}n?(tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 答题完成 ===`,type:"success"})):shouldStop.value?addLog({time:new Date().toLocaleTimeString(),message:"已停止",type:"warning"}):(tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:"答题超时或未开始",type:"error"}))}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`答题失败: ${a.message}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量答题结束")}},batchTopUpFish=async()=>{var t,e,a,n,s,o,u,r,c;if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(l=>{tokenStatus.value[l]="waiting"});for(const l of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=l,tokenStatus.value[l]="running",currentProgress.value=0;const k=tokens.value.find(d=>d.id===l);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始钓鱼补齐: ${k.name} ===`,type:"info"}),await ensureConnection(l),addLog({time:new Date().toLocaleTimeString(),message:"获取月度任务进度...",type:"info"});const d=await tokenStore.sendMessageWithPromise(l,"activity_get",{},1e4),g=(d==null?void 0:d.activity)||((t=d==null?void 0:d.body)==null?void 0:t.activity)||d;if(!g){addLog({time:new Date().toLocaleTimeString(),message:"获取月度任务进度失败",type:"error"}),tokenStatus.value[l]="failed";continue}const m=g.myMonthInfo||{},T=Number(((e=m==null?void 0:m["2"])==null?void 0:e.num)||0),p=calculateMonthProgress(),v=new Date,w=new Date(v.getFullYear(),v.getMonth()+1,0).getDate(),f=v.getDate(),i=Math.max(0,w-f)===0?FISH_TARGET:Math.min(FISH_TARGET,Math.ceil(p*FISH_TARGET)),b=Math.max(0,i-T);if(addLog({time:new Date().toLocaleTimeString(),message:`当前进度: ${T}/${FISH_TARGET}，需要补齐: ${b}次`,type:"info"}),b<=0){addLog({time:new Date().toLocaleTimeString(),message:"当前进度已达标，无需补齐",type:"success"}),tokenStatus.value[l]="completed";continue}addLog({time:new Date().toLocaleTimeString(),message:"开始执行钓鱼补齐...",type:"info"});let y=(n=(a=tokenStore.gameData)==null?void 0:a.roleInfo)==null?void 0:n.role;if(!y)try{const C=await tokenStore.sendGetRoleInfo(l);y=C==null?void 0:C.role}catch{}let S=0;const x=Number(((s=y==null?void 0:y.statisticsTime)==null?void 0:s["artifact:normal:lottery:time"])||0);if(isTodayAvailable(x)){addLog({time:new Date().toLocaleTimeString(),message:"检测到今日免费钓鱼次数，开始消耗 3 次",type:"info"});for(let C=0;C<3&&b>S&&!shouldStop.value;C++)try{await tokenStore.sendMessageWithPromise(l,"artifact_lottery",{lotteryNumber:1,newFree:!0,type:1},8e3),S++,await new Promise(V=>setTimeout(V,500))}catch(V){addLog({time:new Date().toLocaleTimeString(),message:`免费钓鱼失败: ${V.message}`,type:"error"});break}}const h=await tokenStore.sendMessageWithPromise(l,"activity_get",{},1e4),$=((h==null?void 0:h.activity)||((o=h==null?void 0:h.body)==null?void 0:o.activity)||h).myMonthInfo||{},P=Number(((u=$==null?void 0:$["2"])==null?void 0:u.num)||0);let N=Math.max(0,i-P);if(addLog({time:new Date().toLocaleTimeString(),message:`免费次数后进度: ${P}/${FISH_TARGET}，还需补齐: ${N}次`,type:"info"}),N<=0){addLog({time:new Date().toLocaleTimeString(),message:"已通过免费次数完成目标",type:"success"}),tokenStatus.value[l]="completed";continue}for(addLog({time:new Date().toLocaleTimeString(),message:`开始付费钓鱼补齐: 共需 ${N} 次（每次最多10）`,type:"info"});N>0&&!shouldStop.value;){const C=Math.min(10,N);try{await tokenStore.sendMessageWithPromise(l,"artifact_lottery",{lotteryNumber:C,newFree:!0,type:1},12e3),addLog({time:new Date().toLocaleTimeString(),message:`完成 ${C} 次付费钓鱼`,type:"info"}),N-=C,await new Promise(V=>setTimeout(V,800))}catch(V){addLog({time:new Date().toLocaleTimeString(),message:`付费钓鱼失败: ${V.message}`,type:"error"});break}}const D=await tokenStore.sendMessageWithPromise(l,"activity_get",{},1e4),_=((D==null?void 0:D.activity)||((r=D==null?void 0:D.body)==null?void 0:r.activity)||D).myMonthInfo||{},R=Number(((c=_==null?void 0:_["2"])==null?void 0:c.num)||0);R>=i||R>=FISH_TARGET?addLog({time:new Date().toLocaleTimeString(),message:`钓鱼补齐完成，最终进度: ${R}/${FISH_TARGET}`,type:"success"}):addLog({time:new Date().toLocaleTimeString(),message:`钓鱼补齐已停止，未达到目标，最终进度: ${R}/${FISH_TARGET}`,type:"warning"}),tokenStatus.value[l]="completed"}catch(d){console.error(d),tokenStatus.value[l]="failed",addLog({time:new Date().toLocaleTimeString(),message:`钓鱼补齐失败: ${d.message}`,type:"error"})}currentProgress.value=100,await new Promise(d=>setTimeout(d,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量钓鱼补齐结束")}},batchTopUpArena=async()=>{var t,e,a;if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(n=>{tokenStatus.value[n]="waiting"});for(const n of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=n,tokenStatus.value[n]="running",currentProgress.value=0;const s=tokens.value.find(o=>o.id===n);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始竞技场补齐: ${s.name} ===`,type:"info"}),await ensureConnection(n),addLog({time:new Date().toLocaleTimeString(),message:"获取月度任务进度...",type:"info"});const o=await tokenStore.sendMessageWithPromise(n,"activity_get",{},1e4),u=(o==null?void 0:o.activity)||((t=o==null?void 0:o.body)==null?void 0:t.activity)||o;if(!u){addLog({time:new Date().toLocaleTimeString(),message:"获取月度任务进度失败",type:"error"}),tokenStatus.value[n]="failed";continue}const r=u.myArenaInfo||{},c=Number((r==null?void 0:r.num)||0),l=calculateMonthProgress(),k=new Date,d=new Date(k.getFullYear(),k.getMonth()+1,0).getDate(),g=k.getDate(),T=Math.max(0,d-g)===0?ARENA_TARGET:Math.min(ARENA_TARGET,Math.ceil(l*ARENA_TARGET)),p=Math.max(0,T-c);if(addLog({time:new Date().toLocaleTimeString(),message:`当前进度: ${c}/${ARENA_TARGET}，需要补齐: ${p}次`,type:"info"}),p<=0){addLog({time:new Date().toLocaleTimeString(),message:"当前进度已达标，无需补齐",type:"success"}),tokenStatus.value[n]="completed";continue}addLog({time:new Date().toLocaleTimeString(),message:"开始执行竞技场补齐...",type:"info"});try{await tokenStore.sendMessageWithPromise(n,"arena_startarea",{},6e3)}catch(x){addLog({time:new Date().toLocaleTimeString(),message:`开始竞技场失败: ${x.message}`,type:"warning"})}let v=0;const w=100;let f=1,L=p;for(;L>0&&v<w&&!shouldStop.value;){const x=Math.ceil(L/2);addLog({time:new Date().toLocaleTimeString(),message:`第${f}轮：计划战斗 ${x} 场`,type:"info"});for(let N=0;N<x&&v<w&&!shouldStop.value;N++){let D;try{D=await tokenStore.sendMessageWithPromise(n,"arena_getareatarget",{},8e3)}catch(_){addLog({time:new Date().toLocaleTimeString(),message:`获取竞技场目标失败：${_.message}`,type:"error"});break}const M=pickArenaTargetId(D);if(!M){addLog({time:new Date().toLocaleTimeString(),message:"未找到可用的竞技场目标",type:"warning"});break}try{await tokenStore.sendMessageWithPromise(n,"fight_startareaarena",{targetId:M},15e3),addLog({time:new Date().toLocaleTimeString(),message:`竞技场战斗 ${N+1}/${x} 完成`,type:"info"})}catch(_){addLog({time:new Date().toLocaleTimeString(),message:`竞技场对决失败：${_.message}`,type:"error"})}v++,await new Promise(_=>setTimeout(_,1200))}const h=await tokenStore.sendMessageWithPromise(n,"activity_get",{},1e4),$=((h==null?void 0:h.activity)||((e=h==null?void 0:h.body)==null?void 0:e.activity)||h).myArenaInfo||{},P=Number(($==null?void 0:$.num)||0);L=Math.max(0,T-P),addLog({time:new Date().toLocaleTimeString(),message:`第${f}轮后进度: ${P}/${ARENA_TARGET}，还需补齐: ${L}次`,type:"info"}),f++}const i=await tokenStore.sendMessageWithPromise(n,"activity_get",{},1e4),y=((i==null?void 0:i.activity)||((a=i==null?void 0:i.body)==null?void 0:a.activity)||i).myArenaInfo||{},S=Number((y==null?void 0:y.num)||0);S>=T||S>=ARENA_TARGET?addLog({time:new Date().toLocaleTimeString(),message:`竞技场补齐完成，最终进度: ${S}/${ARENA_TARGET}`,type:"success"}):v>=w?addLog({time:new Date().toLocaleTimeString(),message:`达到安全上限，竞技场补齐已停止，最终进度: ${S}/${ARENA_TARGET}`,type:"warning"}):addLog({time:new Date().toLocaleTimeString(),message:`竞技场补齐已停止，未达到目标，最终进度: ${S}/${ARENA_TARGET}`,type:"warning"}),tokenStatus.value[n]="completed"}catch(o){console.error(o),tokenStatus.value[n]="failed",addLog({time:new Date().toLocaleTimeString(),message:`竞技场补齐失败: ${o.message}`,type:"error"})}currentProgress.value=100,await new Promise(o=>setTimeout(o,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量竞技场补齐结束")}},normalizeCars=t=>{const e=t||{},a=e.body||e,n=a.roleCar||a.rolecar||{},s=n.carDataMap||n.cardatamap;if(s&&typeof s=="object")return Object.entries(s).map(([u,r],c)=>({key:c,id:u,...r||{}}));let o=a.cars||a.list||a.data||a.carList||a.vehicles||[];return!Array.isArray(o)&&typeof o=="object"&&o!==null&&(o=Object.values(o)),Array.isArray(a)&&o.length===0&&(o=a),(Array.isArray(o)?o:[]).map((u,r)=>({key:r,...u}))},gradeLabel=t=>({1:"绿·普通",2:"蓝·稀有",3:"紫·史诗",4:"橙·传说",5:"红·神话",6:"金·传奇"})[t]||"未知",isBigPrize=t=>{const e=[{type:3,itemId:3201,value:10},{type:3,itemId:1001,value:10},{type:3,itemId:1022,value:2e3},{type:2,itemId:0,value:2e3},{type:3,itemId:1023,value:5},{type:3,itemId:1022,value:2500},{type:3,itemId:1001,value:12}];return Array.isArray(t)?e.some(a=>t.find(n=>n.type===a.type&&n.itemId===a.itemId&&Number(n.value||0)>=a.value)):!1},countRacingRefreshTickets=t=>Array.isArray(t)?t.reduce((e,a)=>e+(a.type===3&&a.itemId===35002?Number(a.value||0):0),0):0,shouldSendCar=(t,e)=>{const a=Number((t==null?void 0:t.color)||0),n=Array.isArray(t==null?void 0:t.rewards)?t.rewards:[],s=countRacingRefreshTickets(n);return e>=6?a>=5||s>=4||isBigPrize(n):a>=4||s>=2||isBigPrize(n)},canClaim=t=>{const e=Number((t==null?void 0:t.sendAt)||0);if(!e)return!1;const a=e<1e12?e*1e3:e;return Date.now()-a>=FOUR_HOURS_MS},batchSmartSendCar=async()=>{var t,e,a,n,s,o,u;if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(r=>{tokenStatus.value[r]="waiting"});for(const r of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=r,tokenStatus.value[r]="running",currentProgress.value=0;const c=tokens.value.find(l=>l.id===r);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始智能发车: ${c.name} ===`,type:"info"}),await ensureConnection(r),addLog({time:new Date().toLocaleTimeString(),message:"获取车辆信息...",type:"info"});const l=await tokenStore.sendMessageWithPromise(r,"car_getrolecar",{},1e4);let k=normalizeCars((l==null?void 0:l.body)??l),d=0;try{const g=await tokenStore.sendMessageWithPromise(r,"role_getroleinfo",{},1e4),m=(a=(e=(t=g==null?void 0:g.role)==null?void 0:t.items)==null?void 0:e[35002])==null?void 0:a.quantity;d=Number(m||0),addLog({time:new Date().toLocaleTimeString(),message:`剩余车票: ${d}`,type:"info"})}catch{}for(const g of k){if(shouldStop.value)break;if(Number(g.sendAt||0)!==0)continue;if(shouldSendCar(g,d)){addLog({time:new Date().toLocaleTimeString(),message:`车辆[${gradeLabel(g.color)}]满足条件，直接发车`,type:"info"}),await tokenStore.sendMessageWithPromise(r,"car_send",{carId:String(g.id),helperId:0,text:"",isUpgrade:!1},1e4),await new Promise(p=>setTimeout(p,500));continue}let m=!1;const T=Number(g.refreshCount??0)===0;if(d>=6)m=!0;else if(T)m=!0;else{addLog({time:new Date().toLocaleTimeString(),message:`车辆[${gradeLabel(g.color)}]不满足条件且无刷新次数，直接发车`,type:"warning"}),await tokenStore.sendMessageWithPromise(r,"car_send",{carId:String(g.id),helperId:0,text:"",isUpgrade:!1},1e4),await new Promise(p=>setTimeout(p,500));continue}for(;m&&!shouldStop.value;){addLog({time:new Date().toLocaleTimeString(),message:`车辆[${gradeLabel(g.color)}]尝试刷新...`,type:"info"});const p=await tokenStore.sendMessageWithPromise(r,"car_refresh",{carId:String(g.id)},1e4),v=(p==null?void 0:p.car)||((n=p==null?void 0:p.body)==null?void 0:n.car)||p;v&&typeof v=="object"&&(v.color!=null&&(g.color=Number(v.color)),v.refreshCount!=null&&(g.refreshCount=Number(v.refreshCount)),v.rewards!=null&&(g.rewards=v.rewards));try{const f=await tokenStore.sendMessageWithPromise(r,"role_getroleinfo",{},5e3);d=Number(((u=(o=(s=f==null?void 0:f.role)==null?void 0:s.items)==null?void 0:o[35002])==null?void 0:u.quantity)||0)}catch{}if(shouldSendCar(g,d)){addLog({time:new Date().toLocaleTimeString(),message:`刷新后车辆[${gradeLabel(g.color)}]满足条件，发车`,type:"success"}),await tokenStore.sendMessageWithPromise(r,"car_send",{carId:String(g.id),helperId:0,text:"",isUpgrade:!1},1e4),await new Promise(f=>setTimeout(f,500));break}const w=Number(g.refreshCount??0)===0;if(d>=6)m=!0;else if(w)m=!0;else{addLog({time:new Date().toLocaleTimeString(),message:`刷新后车辆[${gradeLabel(g.color)}]仍不满足条件且无刷新次数，发车`,type:"warning"}),await tokenStore.sendMessageWithPromise(r,"car_send",{carId:String(g.id),helperId:0,text:"",isUpgrade:!1},1e4),await new Promise(f=>setTimeout(f,500));break}await new Promise(f=>setTimeout(f,1e3))}}tokenStatus.value[r]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${c.name} 智能发车完成 ===`,type:"success"})}catch(l){console.error(l),tokenStatus.value[r]="failed",addLog({time:new Date().toLocaleTimeString(),message:`智能发车失败: ${l.message}`,type:"error"})}currentProgress.value=100,await new Promise(l=>setTimeout(l,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量智能发车结束")}},batchClaimCars=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始一键收车: ${e.name} ===`,type:"info"}),await ensureConnection(t),addLog({time:new Date().toLocaleTimeString(),message:"获取车辆信息...",type:"info"});const a=await tokenStore.sendMessageWithPromise(t,"car_getrolecar",{},1e4);let n=normalizeCars((a==null?void 0:a.body)??a),s=0;for(const o of n)if(canClaim(o)){try{await tokenStore.sendMessageWithPromise(t,"car_claim",{carId:String(o.id)},1e4),s++,addLog({time:new Date().toLocaleTimeString(),message:`收车成功: ${gradeLabel(o.color)}`,type:"success"})}catch(u){addLog({time:new Date().toLocaleTimeString(),message:`收车失败: ${u.message}`,type:"warning"})}await new Promise(u=>setTimeout(u,300))}s===0&&addLog({time:new Date().toLocaleTimeString(),message:"没有可收取的车辆",type:"info"}),tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 收车完成，共收取 ${s} 辆 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`收车失败: ${a.message}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量一键收车结束")}},startBatch=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;let e=0;const a=1;let n=!1;for(;e<=a&&!n;){const s=tokens.value.find(o=>o.id===t);try{addLog(e===0?{time:new Date().toLocaleTimeString(),message:`=== 开始执行: ${s.name} ===`,type:"info"}:{time:new Date().toLocaleTimeString(),message:`=== 尝试重试: ${s.name} (第${e}次) ===`,type:"info"}),await ensureConnection(t),await runner.run(t,{onLog:o=>addLog(o),onProgress:o=>{currentProgress.value=o}}),n=!0,tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${s.name} 执行完成 ===`,type:"success"})}catch(o){console.error(o),e<a?(addLog({time:new Date().toLocaleTimeString(),message:`执行出错: ${o.message}，等待3秒后重试...`,type:"warning"}),await new Promise(u=>setTimeout(u,3e3)),e++):(tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`执行失败: ${o.message}`,type:"error"}))}}await new Promise(s=>setTimeout(s,1e3))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量任务执行结束")}},batchClaimBoxPointReward=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始领取宝箱积分: ${e.name} ===`,type:"info"}),await ensureConnection(t),await tokenStore.sendMessageWithPromise(t,"item_batchclaimboxpointreward",{},5e3),addLog({time:new Date().toLocaleTimeString(),message:"宝箱积分领取成功",type:"success"}),await tokenStore.sendMessage(t,"role_getroleinfo"),tokenStatus.value[t]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 领取完成 ===`,type:"success"})}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`领取失败: ${a.message}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取宝箱积分结束")}},batchOpenBox=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1;const t=helperSettings.boxType,e=helperSettings.count,a=Math.floor(e/10),n=e%10,s={2001:"木质宝箱",2002:"青铜宝箱",2003:"黄金宝箱",2004:"铂金宝箱"};selectedTokens.value.forEach(o=>{tokenStatus.value[o]="waiting"});for(const o of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=o,tokenStatus.value[o]="running",currentProgress.value=0;const u=tokens.value.find(r=>r.id===o);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始批量开箱: ${u.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`宝箱类型: ${s[t]}, 数量: ${e}`,type:"info"}),await ensureConnection(o);for(let r=0;r<a&&!shouldStop.value;r++)await tokenStore.sendMessageWithPromise(o,"item_openbox",{itemId:t,number:10},5e3),currentProgress.value=Math.floor((r+1)/(a+(n>0?1:0))*100),addLog({time:new Date().toLocaleTimeString(),message:`开箱进度: ${(r+1)*10}/${e}`,type:"info"}),await new Promise(c=>setTimeout(c,300));n>0&&!shouldStop.value&&(await tokenStore.sendMessageWithPromise(o,"item_openbox",{itemId:t,number:n},5e3),addLog({time:new Date().toLocaleTimeString(),message:`开箱进度: ${e}/${e}`,type:"info"})),await tokenStore.sendMessageWithPromise(o,"item_batchclaimboxpointreward"),await new Promise(r=>setTimeout(r,500)),await tokenStore.sendMessage(o,"role_getroleinfo"),tokenStatus.value[o]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${u.name} 开箱完成 ===`,type:"success"})}catch(r){console.error(r),tokenStatus.value[o]="failed",addLog({time:new Date().toLocaleTimeString(),message:`开箱失败: ${r.message}`,type:"error"})}currentProgress.value=100,await new Promise(r=>setTimeout(r,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量开箱结束")},batchFish=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1;const t=helperSettings.fishType,e=helperSettings.count,a=Math.floor(e/10),n=e%10,s={1:"普通鱼竿",2:"黄金鱼竿"};selectedTokens.value.forEach(o=>{tokenStatus.value[o]="waiting"});for(const o of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=o,tokenStatus.value[o]="running",currentProgress.value=0;const u=tokens.value.find(r=>r.id===o);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始批量钓鱼: ${u.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`鱼竿类型: ${s[t]}, 数量: ${e}`,type:"info"}),await ensureConnection(o);for(let r=0;r<a&&!shouldStop.value;r++)await tokenStore.sendMessageWithPromise(o,"artifact_lottery",{type:t,lotteryNumber:10,newFree:!0},5e3),currentProgress.value=Math.floor((r+1)/(a+(n>0?1:0))*100),addLog({time:new Date().toLocaleTimeString(),message:`钓鱼进度: ${(r+1)*10}/${e}`,type:"info"}),await new Promise(c=>setTimeout(c,300));n>0&&!shouldStop.value&&(await tokenStore.sendMessageWithPromise(o,"artifact_lottery",{type:t,lotteryNumber:n,newFree:!0},5e3),addLog({time:new Date().toLocaleTimeString(),message:`钓鱼进度: ${e}/${e}`,type:"info"})),await tokenStore.sendMessage(o,"role_getroleinfo"),tokenStatus.value[o]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${u.name} 钓鱼完成 ===`,type:"success"})}catch(r){console.error(r),tokenStatus.value[o]="failed",addLog({time:new Date().toLocaleTimeString(),message:`钓鱼失败: ${r.message}`,type:"error"})}currentProgress.value=100,await new Promise(r=>setTimeout(r,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量钓鱼结束")},batchRecruit=async()=>{if(selectedTokens.value.length===0)return;isRunning.value=!0,shouldStop.value=!1;const t=helperSettings.count,e=Math.floor(t/10),a=t%10;selectedTokens.value.forEach(n=>{tokenStatus.value[n]="waiting"});for(const n of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=n,tokenStatus.value[n]="running",currentProgress.value=0;const s=tokens.value.find(o=>o.id===n);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始批量招募: ${s.name} ===`,type:"info"}),addLog({time:new Date().toLocaleTimeString(),message:`招募数量: ${t}`,type:"info"}),await ensureConnection(n);for(let o=0;o<e&&!shouldStop.value;o++)await tokenStore.sendMessageWithPromise(n,"hero_recruit",{recruitType:1,recruitNumber:10},5e3),currentProgress.value=Math.floor((o+1)/(e+(a>0?1:0))*100),addLog({time:new Date().toLocaleTimeString(),message:`招募进度: ${(o+1)*10}/${t}`,type:"info"}),await new Promise(u=>setTimeout(u,300));a>0&&!shouldStop.value&&(await tokenStore.sendMessageWithPromise(n,"hero_recruit",{recruitType:1,recruitNumber:a},5e3),addLog({time:new Date().toLocaleTimeString(),message:`招募进度: ${t}/${t}`,type:"info"})),await tokenStore.sendMessage(n,"role_getroleinfo"),tokenStatus.value[n]="completed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${s.name} 招募完成 ===`,type:"success"})}catch(o){console.error(o),tokenStatus.value[n]="failed",addLog({time:new Date().toLocaleTimeString(),message:`招募失败: ${o.message}`,type:"error"})}currentProgress.value=100,await new Promise(o=>setTimeout(o,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量招募结束")},batchClaimFreeEnergy=async()=>{if(selectedTokens.value.length!==0){isRunning.value=!0,shouldStop.value=!1,selectedTokens.value.forEach(t=>{tokenStatus.value[t]="waiting"});for(const t of selectedTokens.value){if(shouldStop.value)break;currentRunningTokenId.value=t,tokenStatus.value[t]="running",currentProgress.value=0;const e=tokens.value.find(a=>a.id===t);try{addLog({time:new Date().toLocaleTimeString(),message:`=== 开始领取怪异塔免费道具: ${e.name} ===`,type:"info"}),await ensureConnection(t);const a=await tokenStore.sendMessageWithPromise(t,"mergebox_getinfo",{actType:1},5e3);a&&a.mergeBox.freeEnergy>0?(await tokenStore.sendMessageWithPromise(t,"mergebox_claimfreeenergy",{actType:1},5e3),addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 成功领取免费道具${a.mergeBox.freeEnergy}个`,type:"success"})):addLog({time:new Date().toLocaleTimeString(),message:`===  ${e.name} 暂无免费道具可领取`,type:"success"}),tokenStatus.value[t]="completed"}catch(a){console.error(a),tokenStatus.value[t]="failed",addLog({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 领取免费道具失败: ${a.message||"未知错误"}`,type:"error"})}currentProgress.value=100,await new Promise(a=>setTimeout(a,500))}isRunning.value=!1,currentRunningTokenId.value=null,message.success("批量领取怪异塔免费道具结束")}},stopBatch=()=>{shouldStop.value=!0,addLog({time:new Date().toLocaleTimeString(),message:"正在停止...",type:"warning"})};return(t,e)=>{const a=resolveComponent("n-button"),n=resolveComponent("n-space"),s=resolveComponent("n-checkbox"),o=resolveComponent("n-tag"),u=resolveComponent("n-icon"),r=resolveComponent("n-grid-item"),c=resolveComponent("n-grid"),l=resolveComponent("n-checkbox-group"),k=resolveComponent("n-card"),d=resolveComponent("n-progress"),g=resolveComponent("n-select"),m=resolveComponent("n-switch"),T=resolveComponent("n-modal"),p=resolveComponent("n-input-number"),v=resolveComponent("n-input"),w=resolveComponent("n-radio"),f=resolveComponent("n-radio-group"),L=resolveComponent("n-time-picker");return openBlock(),createElementBlock("div",_hoisted_1,[createBaseVNode("div",_hoisted_2,[createBaseVNode("div",_hoisted_3,[createBaseVNode("div",_hoisted_4,[e[32]||(e[32]=createBaseVNode("h2",null,"批量日常任务",-1)),createBaseVNode("div",_hoisted_5,[createVNode(a,{type:"primary",onClick:startBatch,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[createTextVNode(toDisplayString(isRunning.value?"执行中...":"开始执行"),1)]),_:1},8,["disabled"]),createVNode(a,{onClick:stopBatch,disabled:!isRunning.value,type:"error",style:{"margin-left":"12px"}},{default:withCtx(()=>[...e[31]||(e[31]=[createTextVNode(" 停止 ",-1)])]),_:1},8,["disabled"])])]),createVNode(k,{title:"账号列表",class:"token-list-card"},{default:withCtx(()=>[createVNode(n,{style:{"margin-bottom":"12px"}},{default:withCtx(()=>[createVNode(a,{size:"small",onClick:claimHangUpRewards,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[33]||(e[33]=[createTextVNode(" 领取挂机 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchAddHangUpTime,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[34]||(e[34]=[createTextVNode(" 一键加钟 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:resetBottles,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[35]||(e[35]=[createTextVNode(" 重置罐子 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchlingguanzi,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[36]||(e[36]=[createTextVNode(" 一键领取罐子 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:climbTower,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[37]||(e[37]=[createTextVNode(" 一键爬塔 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchStudy,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[38]||(e[38]=[createTextVNode(" 一键答题 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchSmartSendCar,disabled:isRunning.value||selectedTokens.value.length===0||!isCarActivityOpen.value},{default:withCtx(()=>[...e[39]||(e[39]=[createTextVNode(" 智能发车 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchClaimCars,disabled:isRunning.value||selectedTokens.value.length===0||!isCarActivityOpen.value},{default:withCtx(()=>[...e[40]||(e[40]=[createTextVNode(" 一键收车 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:e[0]||(e[0]=i=>openHelperModal("box")),disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[41]||(e[41]=[createTextVNode(" 批量开箱 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchClaimBoxPointReward,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[42]||(e[42]=[createTextVNode(" 领取宝箱积分 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:e[1]||(e[1]=i=>openHelperModal("fish")),disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[43]||(e[43]=[createTextVNode(" 批量钓鱼 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:e[2]||(e[2]=i=>openHelperModal("recruit")),disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[44]||(e[44]=[createTextVNode(" 批量招募 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchbaoku13,disabled:isRunning.value||selectedTokens.value.length===0||!isbaokuActivityOpen.value},{default:withCtx(()=>[...e[45]||(e[45]=[createTextVNode(" 一键宝库前3层 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchbaoku45,disabled:isRunning.value||selectedTokens.value.length===0||!isbaokuActivityOpen.value},{default:withCtx(()=>[...e[46]||(e[46]=[createTextVNode(" 一键宝库4,5层 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchmengjing,disabled:isRunning.value||selectedTokens.value.length===0||!ismengjingActivityOpen.value},{default:withCtx(()=>[...e[47]||(e[47]=[createTextVNode(" 一键梦境 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchclubsign,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[48]||(e[48]=[createTextVNode(" 一键俱乐部签到 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batcharenafight,disabled:isRunning.value||selectedTokens.value.length===0||!isarenaActivityOpen.value},{default:withCtx(()=>[...e[49]||(e[49]=[createTextVNode(" 一键竞技场战斗3次 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchTopUpFish,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[50]||(e[50]=[createTextVNode(" 一键钓鱼补齐 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchTopUpArena,disabled:isRunning.value||selectedTokens.value.length===0||!isarenaActivityOpen.value},{default:withCtx(()=>[...e[51]||(e[51]=[createTextVNode(" 一键竞技场补齐 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:batchClaimFreeEnergy,disabled:isRunning.value||selectedTokens.value.length===0||!isWeirdTowerActivityOpen.value},{default:withCtx(()=>[...e[52]||(e[52]=[createTextVNode(" 一键领取怪异塔免费道具 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:legion_storebuygoods,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[53]||(e[53]=[createTextVNode(" 一键购买四圣碎片 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:store_purchase,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[54]||(e[54]=[createTextVNode(" 一键黑市采购 ",-1)])]),_:1},8,["disabled"]),createVNode(a,{size:"small",onClick:collection_claimfreereward,disabled:isRunning.value||selectedTokens.value.length===0},{default:withCtx(()=>[...e[55]||(e[55]=[createTextVNode(" 免费领取珍宝阁 ",-1)])]),_:1},8,["disabled"])]),_:1}),createVNode(n,{vertical:""},{default:withCtx(()=>[createVNode(s,{checked:isAllSelected.value,indeterminate:isIndeterminate.value,"onUpdate:checked":handleSelectAll},{default:withCtx(()=>[...e[56]||(e[56]=[createTextVNode(" 全选 ",-1)])]),_:1},8,["checked","indeterminate"]),createVNode(l,{value:selectedTokens.value,"onUpdate:value":e[3]||(e[3]=i=>selectedTokens.value=i)},{default:withCtx(()=>[createVNode(c,{"x-gap":12,"y-gap":8,cols:2},{default:withCtx(()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(tokens.value,i=>(openBlock(),createBlock(r,{key:i.id},{default:withCtx(()=>[createBaseVNode("div",_hoisted_6,[createVNode(s,{value:i.id,label:i.name,style:{flex:"1"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_7,[createBaseVNode("span",null,toDisplayString(i.name),1),createVNode(o,{size:"small",type:getStatusType(i.id),style:{"margin-left":"8px"}},{default:withCtx(()=>[createTextVNode(toDisplayString(getStatusText(i.id)),1)]),_:2},1032,["type"])])]),_:2},1032,["value","label"]),createVNode(a,{size:"tiny",circle:"",onClick:withModifiers(b=>openSettings(i),["stop"])},{icon:withCtx(()=>[createVNode(u,null,{default:withCtx(()=>[createVNode(unref(Settings))]),_:1})]),_:1},8,["onClick"])])]),_:2},1024))),128))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),createVNode(k,{title:"定时任务",class:"scheduled-tasks-card",style:{"margin-top":"16px"}},{default:withCtx(()=>[createVNode(n,{style:{"margin-bottom":"12px"}},{default:withCtx(()=>[createVNode(a,{type:"primary",size:"small",onClick:openTaskModal},{default:withCtx(()=>[...e[57]||(e[57]=[createTextVNode(" 新增定时任务 ",-1)])]),_:1}),createVNode(a,{size:"small",onClick:e[4]||(e[4]=i=>showTasksModal.value=!0)},{default:withCtx(()=>[...e[58]||(e[58]=[createTextVNode(" 查看定时任务 ",-1)])]),_:1})]),_:1}),createBaseVNode("div",_hoisted_8,[e[59]||(e[59]=createBaseVNode("h4",{style:{margin:"0 0 12px 0",color:"#333"}},"即将执行的任务",-1)),shortestCountdownTask.value?(openBlock(),createElementBlock("div",_hoisted_9,[createBaseVNode("div",_hoisted_10,toDisplayString(shortestCountdownTask.value.task.name),1),createBaseVNode("div",{style:normalizeStyle([{"font-size":"24px","font-weight":"bold",color:"#1677ff"},{color:shortestCountdownTask.value.countdown.isNearExecution?"#ff4d4f":"#1677ff"}])},toDisplayString(shortestCountdownTask.value.countdown.formatted),5)])):(openBlock(),createElementBlock("div",_hoisted_11," 暂无定时任务 "))]),scheduledTasks.value.length>0?(openBlock(),createElementBlock("div",_hoisted_12,[createBaseVNode("p",null,"已保存 "+toDisplayString(scheduledTasks.value.length)+" 个定时任务",1)])):(openBlock(),createElementBlock("div",_hoisted_13,[...e[60]||(e[60]=[createBaseVNode("p",null,"暂无定时任务",-1)])]))]),_:1})]),createBaseVNode("div",_hoisted_14,[createVNode(k,{title:currentRunningTokenName.value?`正在执行: ${currentRunningTokenName.value}`:"执行日志",class:"log-card"},{"header-extra":withCtx(()=>[createBaseVNode("div",_hoisted_15,[createVNode(s,{checked:autoScrollLog.value,"onUpdate:checked":e[5]||(e[5]=i=>autoScrollLog.value=i),size:"small"},{default:withCtx(()=>[...e[61]||(e[61]=[createTextVNode(" 自动滚动 ",-1)])]),_:1},8,["checked"]),createVNode(a,{size:"small",onClick:copyLogs,style:{"margin-left":"8px"}},{default:withCtx(()=>[...e[62]||(e[62]=[createTextVNode(" 复制日志 ",-1)])]),_:1})])]),default:withCtx(()=>[createVNode(d,{type:"line",percentage:currentProgress.value,"indicator-placement":"inside",processing:""},null,8,["percentage"]),createBaseVNode("div",{class:"log-container",ref_key:"logContainer",ref:logContainer},[(openBlock(!0),createElementBlock(Fragment,null,renderList(logs.value,(i,b)=>(openBlock(),createElementBlock("div",{key:b,class:normalizeClass(["log-item",i.type])},[createBaseVNode("span",_hoisted_16,toDisplayString(i.time),1),createBaseVNode("span",_hoisted_17,toDisplayString(i.message),1)],2))),128))],512)]),_:1},8,["title"])])]),createVNode(T,{show:showSettingsModal.value,"onUpdate:show":e[16]||(e[16]=i=>showSettingsModal.value=i),preset:"card",title:`任务设置 - ${currentSettingsTokenName.value}`,style:{width:"90%","max-width":"400px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_18,[createBaseVNode("div",_hoisted_19,[createBaseVNode("div",_hoisted_20,[e[63]||(e[63]=createBaseVNode("label",{class:"setting-label"},"竞技场阵容",-1)),createVNode(g,{value:currentSettings.arenaFormation,"onUpdate:value":e[6]||(e[6]=i=>currentSettings.arenaFormation=i),options:unref(formationOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_21,[e[64]||(e[64]=createBaseVNode("label",{class:"setting-label"},"BOSS阵容",-1)),createVNode(g,{value:currentSettings.bossFormation,"onUpdate:value":e[7]||(e[7]=i=>currentSettings.bossFormation=i),options:unref(formationOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_22,[e[65]||(e[65]=createBaseVNode("label",{class:"setting-label"},"BOSS次数",-1)),createVNode(g,{value:currentSettings.bossTimes,"onUpdate:value":e[8]||(e[8]=i=>currentSettings.bossTimes=i),options:unref(bossTimesOptions),size:"small"},null,8,["value","options"])]),createBaseVNode("div",_hoisted_23,[createBaseVNode("div",_hoisted_24,[e[66]||(e[66]=createBaseVNode("span",{class:"switch-label"},"领罐子",-1)),createVNode(m,{value:currentSettings.claimBottle,"onUpdate:value":e[9]||(e[9]=i=>currentSettings.claimBottle=i)},null,8,["value"])]),createBaseVNode("div",_hoisted_25,[e[67]||(e[67]=createBaseVNode("span",{class:"switch-label"},"领挂机",-1)),createVNode(m,{value:currentSettings.claimHangUp,"onUpdate:value":e[10]||(e[10]=i=>currentSettings.claimHangUp=i)},null,8,["value"])]),createBaseVNode("div",_hoisted_26,[e[68]||(e[68]=createBaseVNode("span",{class:"switch-label"},"竞技场",-1)),createVNode(m,{value:currentSettings.arenaEnable,"onUpdate:value":e[11]||(e[11]=i=>currentSettings.arenaEnable=i)},null,8,["value"])]),createBaseVNode("div",_hoisted_27,[e[69]||(e[69]=createBaseVNode("span",{class:"switch-label"},"开宝箱",-1)),createVNode(m,{value:currentSettings.openBox,"onUpdate:value":e[12]||(e[12]=i=>currentSettings.openBox=i)},null,8,["value"])]),createBaseVNode("div",_hoisted_28,[e[70]||(e[70]=createBaseVNode("span",{class:"switch-label"},"领取邮件奖励",-1)),createVNode(m,{value:currentSettings.claimEmail,"onUpdate:value":e[13]||(e[13]=i=>currentSettings.claimEmail=i)},null,8,["value"])]),createBaseVNode("div",_hoisted_29,[e[71]||(e[71]=createBaseVNode("span",{class:"switch-label"},"黑市购买物品",-1)),createVNode(m,{value:currentSettings.blackMarketPurchase,"onUpdate:value":e[14]||(e[14]=i=>currentSettings.blackMarketPurchase=i)},null,8,["value"])]),createBaseVNode("div",_hoisted_30,[e[72]||(e[72]=createBaseVNode("span",{class:"switch-label"},"付费招募",-1)),createVNode(m,{value:currentSettings.payRecruit,"onUpdate:value":e[15]||(e[15]=i=>currentSettings.payRecruit=i)},null,8,["value"])])])]),createBaseVNode("div",_hoisted_31,[createVNode(a,{type:"primary",onClick:saveSettings},{default:withCtx(()=>[...e[73]||(e[73]=[createTextVNode("保存设置",-1)])]),_:1})])])]),_:1},8,["show","title"]),createVNode(T,{show:showHelperModal.value,"onUpdate:show":e[21]||(e[21]=i=>showHelperModal.value=i),preset:"card",title:helperModalTitle.value,style:{width:"90%","max-width":"400px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_32,[createBaseVNode("div",_hoisted_33,[helperType.value==="box"?(openBlock(),createElementBlock("div",_hoisted_34,[e[74]||(e[74]=createBaseVNode("label",{class:"setting-label"},"宝箱类型",-1)),createVNode(g,{value:helperSettings.boxType,"onUpdate:value":e[17]||(e[17]=i=>helperSettings.boxType=i),options:boxTypeOptions,size:"small"},null,8,["value"])])):createCommentVNode("",!0),helperType.value==="fish"?(openBlock(),createElementBlock("div",_hoisted_35,[e[75]||(e[75]=createBaseVNode("label",{class:"setting-label"},"鱼竿类型",-1)),createVNode(g,{value:helperSettings.fishType,"onUpdate:value":e[18]||(e[18]=i=>helperSettings.fishType=i),options:fishTypeOptions,size:"small"},null,8,["value"])])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_36,[e[76]||(e[76]=createBaseVNode("label",{class:"setting-label"},"消耗数量（10的倍数）",-1)),createVNode(p,{value:helperSettings.count,"onUpdate:value":e[19]||(e[19]=i=>helperSettings.count=i),min:10,max:1e4,step:10,size:"small"},null,8,["value"])])]),createBaseVNode("div",_hoisted_37,[createVNode(a,{onClick:e[20]||(e[20]=i=>showHelperModal.value=!1),style:{"margin-right":"12px"}},{default:withCtx(()=>[...e[77]||(e[77]=[createTextVNode("取消",-1)])]),_:1}),createVNode(a,{type:"primary",onClick:executeHelper},{default:withCtx(()=>[...e[78]||(e[78]=[createTextVNode("开始执行",-1)])]),_:1})])])]),_:1},8,["show","title"]),createVNode(T,{show:showTasksModal.value,"onUpdate:show":e[22]||(e[22]=i=>showTasksModal.value=i),preset:"card",title:"定时任务列表",style:{width:"90%","max-width":"800px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_38,[(openBlock(!0),createElementBlock(Fragment,null,renderList(scheduledTasks.value,i=>{var b,y;return openBlock(),createElementBlock("div",{key:i.id,class:"task-item",style:{"margin-bottom":"16px",padding:"12px",border:"1px solid #e5e7eb","border-radius":"8px"}},[createBaseVNode("div",_hoisted_39,[createBaseVNode("div",_hoisted_40,toDisplayString(i.name),1),createVNode(m,{value:i.enabled,"onUpdate:value":[S=>i.enabled=S,S=>toggleTaskEnabled(i.id,S)]},null,8,["value","onUpdate:value"])]),createBaseVNode("div",_hoisted_41,[e[79]||(e[79]=createBaseVNode("span",{style:{color:"#6b7280"}},"运行类型：",-1)),createBaseVNode("span",null,toDisplayString(i.runType==="daily"?"每天固定时间":"Cron表达式"),1)]),createBaseVNode("div",_hoisted_42,[e[80]||(e[80]=createBaseVNode("span",{style:{color:"#6b7280"}},"运行时间：",-1)),createBaseVNode("span",null,toDisplayString(i.runType==="daily"?i.runTime:i.cronExpression),1)]),createBaseVNode("div",_hoisted_43,[e[81]||(e[81]=createBaseVNode("span",{style:{color:"#6b7280"}},"下次执行：",-1)),createBaseVNode("span",{style:normalizeStyle({fontWeight:"bold",color:(b=taskCountdowns.value[i.id])!=null&&b.isNearExecution?"#ff4d4f":"#1677ff"})},toDisplayString(((y=taskCountdowns.value[i.id])==null?void 0:y.formatted)||"计算中..."),5)]),createBaseVNode("div",_hoisted_44,[e[82]||(e[82]=createBaseVNode("span",{style:{color:"#6b7280"}},"选中账号：",-1)),createBaseVNode("span",null,toDisplayString(i.selectedTokens.length)+" 个",1)]),createBaseVNode("div",_hoisted_45,[e[83]||(e[83]=createBaseVNode("span",{style:{color:"#6b7280"}},"选中任务：",-1)),createBaseVNode("span",null,toDisplayString(i.selectedTasks.length)+" 个",1)]),createBaseVNode("div",_hoisted_46,[createVNode(a,{size:"tiny",onClick:S=>editTask(i)},{default:withCtx(()=>[...e[84]||(e[84]=[createTextVNode(" 编辑 ",-1)])]),_:1},8,["onClick"]),createVNode(a,{size:"tiny",type:"error",onClick:S=>deleteTask(i.id)},{default:withCtx(()=>[...e[85]||(e[85]=[createTextVNode(" 删除 ",-1)])]),_:1},8,["onClick"])])])}),128)),scheduledTasks.value.length===0?(openBlock(),createElementBlock("div",_hoisted_47," 暂无定时任务 ")):createCommentVNode("",!0)])]),_:1},8,["show"]),createVNode(T,{show:showTaskModal.value,"onUpdate:show":e[30]||(e[30]=i=>showTaskModal.value=i),preset:"card",title:editingTask.value?"编辑定时任务":"新增定时任务",style:{width:"90%","max-width":"600px"}},{default:withCtx(()=>[createBaseVNode("div",_hoisted_48,[createBaseVNode("div",_hoisted_49,[createBaseVNode("div",_hoisted_50,[e[86]||(e[86]=createBaseVNode("label",{class:"setting-label"},"任务名称",-1)),createVNode(v,{value:taskForm.name,"onUpdate:value":e[23]||(e[23]=i=>taskForm.name=i),placeholder:"请输入任务名称"},null,8,["value"])]),createBaseVNode("div",_hoisted_51,[e[89]||(e[89]=createBaseVNode("label",{class:"setting-label"},"运行类型",-1)),createVNode(f,{value:taskForm.runType,"onUpdate:value":[e[24]||(e[24]=i=>taskForm.runType=i),resetRunType]},{default:withCtx(()=>[createVNode(w,{value:"daily"},{default:withCtx(()=>[...e[87]||(e[87]=[createTextVNode("每天固定时间",-1)])]),_:1}),createVNode(w,{value:"cron"},{default:withCtx(()=>[...e[88]||(e[88]=[createTextVNode("Cron表达式",-1)])]),_:1})]),_:1},8,["value"])]),taskForm.runType==="daily"?(openBlock(),createElementBlock("div",_hoisted_52,[e[90]||(e[90]=createBaseVNode("label",{class:"setting-label"},"运行时间",-1)),createVNode(L,{value:taskForm.runTime,"onUpdate:value":e[25]||(e[25]=i=>taskForm.runTime=i),format:"HH:mm"},null,8,["value"])])):createCommentVNode("",!0),taskForm.runType==="cron"?(openBlock(),createElementBlock("div",_hoisted_53,[e[91]||(e[91]=createBaseVNode("label",{class:"setting-label"},"Cron表达式",-1)),createVNode(v,{value:taskForm.cronExpression,"onUpdate:value":e[26]||(e[26]=i=>taskForm.cronExpression=i),placeholder:"请输入Cron表达式"},null,8,["value"])])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_54,[createBaseVNode("div",_hoisted_55,[e[94]||(e[94]=createBaseVNode("label",{class:"setting-label"},"选择账号",-1)),createVNode(n,{size:"small"},{default:withCtx(()=>[createVNode(a,{size:"small",onClick:selectAllTokens},{default:withCtx(()=>[...e[92]||(e[92]=[createTextVNode(" 全选 ",-1)])]),_:1}),createVNode(a,{size:"small",onClick:deselectAllTokens},{default:withCtx(()=>[...e[93]||(e[93]=[createTextVNode(" 全不选 ",-1)])]),_:1})]),_:1})]),createVNode(l,{value:taskForm.selectedTokens,"onUpdate:value":e[27]||(e[27]=i=>taskForm.selectedTokens=i)},{default:withCtx(()=>[createVNode(c,{cols:2,"x-gap":12,"y-gap":8},{default:withCtx(()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(tokens.value,i=>(openBlock(),createBlock(r,{key:i.id},{default:withCtx(()=>[createVNode(s,{value:i.id},{default:withCtx(()=>[createTextVNode(toDisplayString(i.name),1)]),_:2},1032,["value"])]),_:2},1024))),128))]),_:1})]),_:1},8,["value"])]),createBaseVNode("div",_hoisted_56,[createBaseVNode("div",_hoisted_57,[e[97]||(e[97]=createBaseVNode("label",{class:"setting-label"},"选择任务",-1)),createVNode(n,{size:"small"},{default:withCtx(()=>[createVNode(a,{size:"small",onClick:selectAllTasks},{default:withCtx(()=>[...e[95]||(e[95]=[createTextVNode(" 全选 ",-1)])]),_:1}),createVNode(a,{size:"small",onClick:deselectAllTasks},{default:withCtx(()=>[...e[96]||(e[96]=[createTextVNode(" 全不选 ",-1)])]),_:1})]),_:1})]),createVNode(l,{value:taskForm.selectedTasks,"onUpdate:value":e[28]||(e[28]=i=>taskForm.selectedTasks=i)},{default:withCtx(()=>[createVNode(c,{cols:2,"x-gap":12,"y-gap":8},{default:withCtx(()=>[(openBlock(),createElementBlock(Fragment,null,renderList(availableTasks,i=>createVNode(r,{key:i.value},{default:withCtx(()=>[createVNode(s,{value:i.value},{default:withCtx(()=>[createTextVNode(toDisplayString(i.label),1)]),_:2},1032,["value"])]),_:2},1024)),64))]),_:1})]),_:1},8,["value"])])]),createBaseVNode("div",_hoisted_58,[createVNode(a,{onClick:e[29]||(e[29]=i=>showTaskModal.value=!1),style:{"margin-right":"12px"}},{default:withCtx(()=>[...e[98]||(e[98]=[createTextVNode("取消",-1)])]),_:1}),createVNode(a,{type:"primary",onClick:saveTask},{default:withCtx(()=>[...e[99]||(e[99]=[createTextVNode("保存",-1)])]),_:1})])])]),_:1},8,["show","title"])])}}},BatchDailyTasks=_export_sfc(_sfc_main,[["__scopeId","data-v-4cddf633"]]);export{BatchDailyTasks as default};
